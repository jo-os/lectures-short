# Linux 1

## Процессы
**Процесс** - Программа во время выполнения или Сущность, представляющая понятие активности/работы с точки зрения операционной системы
- **ps auxf**
  - PID - идентификатор
  - TTY - устройство на котором запущен
  - STAT - статус
  - TIME - время CPU использованное процессом
  - COMMAND - команда запуска
  - START - время запуска
- **STAT**
  - R — выполняется
  - D — uninterruptable sleep (ожидает ввод-вывод)
  - S — interruptable sleep
  - I — idle (бездействует > 20 секунд)
  - T — приостановлен
  - Z — зомби
  - W — выгружен на диск (swap file)
  - < — имеет повышенный приоритет
  - N — имеет пониженный приоритет
  - L — страницы заблокированы в ядре
  - s — лидер сеанса (например, консоль)

- **pidstat (sudo apt install sysstat) - pidstat -p 1583(id) 1** - показывает через 1 секунду процесс
- cat /proc/**cpuinfo** - информация о CPU
- cat /proc/**version** — версия Linux
- cat /proc/**stat** - cистемная статистика
- **strace** - нужен для отладки - отображает каждый системный вызов, выполненный процессом и каждый полученный сигнал - подключается по PID и показывает в реальном времени (если без параметров)
- strace echo 1 - системный вызов echo 1
- PID / PPID - уникальный идентификатор процесса / идентификатор родительского процесса
- UID / EUID - дентификатор пользователя, создавшего данный процесс / текущий идентификатор пользователя процесса
- Сигнал (signal) — уведомление процесса о каком-либо событии
- kill -l - набор сигналов
- pgrep - грепаем id процесса можно регуляркой - pgrep "^dd$"
- kill (-10) -SIGUSR1 3830239(PID) - вернет прогресс по процессу
- kill (-2) -**SIGINT** 3830239(PID) - запрос на завершение текущей операции (CTRL-C)
- kill -9 (**-KILL**) PID - завершает процесс на уровне ядра. Не блокируется
- kill -15 (**-TERM**) PID - запрос на завершение программы
- sudo kill -pid- / sudo killall nano / sudo pkill -u user1
- Потоки (нити, threads) — программно выделенные части одного процесса, использующие его ресурсы совместно
- **ps m** - просмотр потоков
- **ps -eLf** - просмотр потоков (одинаковый pid у потоков)

## Память
- **RAM** (Random Access Memory, память с произвольным доступом) или ОЗУ (Оперативное Запоминающее Устройство) — энергозависимая память с произвольным доступом к ячейкам RAM, ОЗУ — энергозависимое запоминающее устройство, в котором во время работы компьютера хранится исполняемый код и входные/выходные данные.
- **ROM** (Read Only Memory, память только для чтения) или ПЗУ (постоянное запоминающее устройство) - энергонезависимая память для хранения массива неизменяемых данных
- **lscpu** - позволяет отобразить информация о процессоре
- **dmidecode** -t memory / dmidecode -t baseboard - позволяет получить информацию о комплектующих ПК
- cat /proc/**meminfo** - раздел файловой системы /proc с текущей информацией о состоянии памяти в операционной системе.

**Виртуальная память** - Абстракция, которая позволяет выполнять программы, требующие больше оперативной памяти, чем имеется в компьютере, путём автоматического перемещения частей программы между основной памятью и другими хранилищами.

**Cache** — промежуточный буфер с быстрым доступом для хранения информации, которая с большой вероятностью будет запрошена.

**Кэш-память** — сверхбыстрая память используемая процессором, для временного хранения данных, которые наиболее часто используются.

- **sysctl -a | grep dirty** - найти в настройках Linux параметры, которые используются при кэшировании 
- **swapon -s**; grep Swap /proc/meminfo; free -h - команды показывают использование файла подкачки
- **mkswap /swapfile** - размечает файл /swapfile как файловую систему swap
- **swapoff\swapon /swapfile** - отключение/подключение файла подкачки в систему
- cat **/etc/fstab** - выводит список устройств для монтирования. Можно приписать swap раздел
- /proc/sys/vm/swappiness — процент переноса данных в swap

## Планировщик задач
**Планировщик** (шедулер, англ. scheduler) — часть операционной системы, ответственная за распределение ресурсов компьютера между рабочими юнитами (процессами, потоками, пользователями и т. д.) Программно невозможно понять, что прошло какое-то время. Остаётся использовать аппаратные прерывания. Используем аппаратные прерывания от контроллера прерываний периферии, в частности — timer.
- **Кооперативная многозадачность** - Процессы сами по доброй воле (вызовом специальной команды) отдают управление (простота, скорость, низкая отзывчивость, зависания)
- **Вытесняющая многозадачность** - Планировщик (по таймеру) останавливает текущий процесс и передаёт управление другому (прогнозируемая отзывчивость, независимость процессов, схожая скорость число-дробилок, дороже)

- **vmstat 5 1** - предоставляет краткую информацию о различных ресурсах системы и связанных с ними неполадках, приводящих к снижению производительности
<details>
  <summary>VMSTAT</summary>
  
**Procs**(vmstat)
- r: количество запущенных процессов (работающих или ожидающих выполнения).
- b: количество спящих процессов.

**Memory**(vmstat)
- swpd: объем используемой виртуальной памяти.
- free: объем свободной памяти.
- buff: количество памяти, используемой в качестве буферов.
- cache: объем памяти, используемой в качестве кеша.
- inact: количество неактивной памяти (опция -a).
- active: количество активной памяти. (опция -a)

**Swap**(vmstat)
- si: объем памяти, выгруженный с диска (/s).
- so: объем памяти, перенесенный на диск (/s).

**IO**(vmstat)
- bi: блоки, полученные от блочного устройства (blocks/s).
- bo: блоки, отправленные на блочное устройство (blocks/s).

**System**(vmstat)
- in: количество прерываний в секунду, включая часы.
- cs: количество переключений контекста в секунду.

**CPU**(vmstat) Здесь проценты от общего времени процессора.
- us: время, потраченное на запуск кода, не относящегося к ядру (время пользователя).
- sy: время, потраченное на выполнение кода ядра (системное время).
- id: время бездействия. До версии Linux 2.5.41 это включает время ожидания ввода-вывода.
- wa: время, проведенное в ожидании ввода/вывода. До Linux 2.5.41, включено в idle.
- st: время, украденное из виртуальной машины. До Linux 2.6.11 неизвестно.
</details>

- **ps ax -o pid,ni,cmd** — чтобы посмотреть nice запущенных процессов

**CFS планировщик**
- храним не процессы, а **sched_entity** — планировщик может рассчитывать время, например, для пользователей;
- все sched_entity лежат в бинарном сбалансированном дереве, отсортированном по оставшемуся времени исполнения и имеет сложность O(logN);
- CFS планировщик более справедлив — при равном приоритете задачи будут получать более равные кванты, чем в O(1);
- Работает сразу на все процессоры — нет проблемы с локальными spinlock-ами.

## Дисковые системы
- **DAS** – блочное устройство с диска, который физически, напрямую, подключен к хост-машине. Необходимо поместить на нее файловую систему, прежде чем ее можно будет использовать. Технологии для этого включают IDE, SCSI, SATA и т.д.
- **SAN** – блочное устройство, которое доставляется по сети. Как и DAS, вы все равно должны разместить на нем файловую систему, прежде чем она сможет использоваться. Технологии для этого включают FibreChannel, iSCSI, FoE и т. Д.
- **NAS** – файловая система, доставляемая по сети. Технологии для этого включают NFS, CIFS, AFS и т.д.
- **СХД** (сеть хранения данных, SAN, storage area network) – архитектурное решение для подключения внешних устройств хранения данных (дисковые массивы, ленточные библиотеки) к серверам таким образом, чтобы операционная система распознала подключённые ресурсы как локальные
- cat /proc/devices - отображает список устройств, опознанных ядром
- ls -la /dev - каталог специального назначения, который содержит файлы устройств
- **lshw -short** -C disk, hdparm -I /dev/sda, smartctl --all /dev/nvme0 - утилиты, которые отображают информацию об имеющихся дисках с точки зрения железа
- **stat /dev/sda** - информация о устройстве

**Виртуальная файловая система** (англ. virtual file system — VFS) - это абстрактный уровень поверх конкретной реализации файловой системы. Она используется для доступа к локальным файловым системам(ФС) (fat32, ext4, ntfs), сетевым ФС(nfs), а также к устройствам, не предназначенным для хранения данных (procfs). VFS предоставляет единообразный доступ клиентских приложений к различным типам файловых систем. **VFS декларирует программный интерфейс между ядром и конкретной файловой системой**, таким образом, для добавления поддержки новой файловой системы не требуется вносить изменений в ядро операционной системы

**Device mapper** - Подсистема ядра Linux, которая позволяет мэппить одно блочное устройство на другое или несколько других. Это позволяет реализовать объединение нескольких реальных устройств в одно виртуальное, создавать snapshot’ы, организовывать балансировку между устройствами, делать шифрованные тома и т.д. Через device-mapper, в качестве низкоуровнего API, работают LVM, cryptsetup, dm-multipath и другие утилиты

**MBR** (Master Boot Record, главная загрузочная запись) содержит сведения о структуре жесткого диска и код для запуска операционной системы

![mbr](https://github.com/joos-linux/linux-ntlg/blob/main/mbr.png)

**GUID** (Globally Unique Identifier) Partition Table (GPT) — стандарт формата размещения таблиц разделов на физическом жестком диске. Является частью расширяемого микропрограммного интерфейса, Extensible Firmware Interface, EFI.

![gpt](https://github.com/joos-linux/linux-ntlg/blob/main/gpt.png)

- **lsblk** – утилита выводит список блочных устройств с информацией о них
- **blkid** – утилита отображает информацию об уникальных идентификаторах блочных устройств
- **fdisk** – утилита позволяет управлять разделами с разметкой MBR
- fdisk /dev/sdb  | o - DOS, g - gpt,  n - add partition, d - delete
- gdisk – утилита позволяет управлять разделами с разметкой GPT
- parted – утилита позволяет управлять разделами с разметкой MBR и GPT. В отличие от gdisk и fdisk изменения применяются сразу, не требуя подтверждения
- cat /proc/partitions – вывести список разделов
- **RAID** (Redundant Array of Independent Disks, избыточный массив независимых дисков) — технология виртуализации данных, которая объединяет несколько дисков в логический элемент для повышения производительности и отказоустойчивости
```
sudo yum (apt-get) install mdadm — установка утилиты
sudo mdadm --create /dev/md0 -l 1 -n 2 /dev/sd{b,c} — создание нового массива
```
- cat /proc/mdstat - текущее состояние
- /etc/mdadm.conf - файл конфигурации

**LVM** - (Logical Volume Manager, Менеджер логических томов) — это дополнительный слой абстракции между «железом» и файловой системой, позволяющий использовать разные области одного жёсткого диска и/или области с разных жёстких дисков как один логический том.

**Преимущества LVM**
- легко изменять размер логических томов,
- можно объединять несколько физических устройств в один логический пул,
- возможное количество логических томов намного превышает возможности традиционного деления диска на разделы
- с помощью снэпшотов можно делать бэкапы логических томов.
- **pvcreate, vgcreate, lvcreate** - create volume, volume group, logic volume
- **pvs, vgs, lvs** - show volume, volume group, logic volume

- **iostat** - мониторинг использования дисковых разделов
- **iotop** - аналогична утилите top, но вместо использования процесами CPU и памяти показывает работу процессов с дисками
- **sar -p -d 5 3** - утилита для отображения различных параметров (статистики) работы системы

## Файловые системы
- Часть операционной системы,которая устанавливает физическую и логическую структуру файлов на разделе или диске, управляет созданием и изменением файлов и сопутствующих данных. В Linux на каждый раздел можно установить свою ФС, которая отвечает за порядок и способ организации информации.

**Функции файловых систем**
- размещение и упорядочивание на носителе данных в виде файлов;
- создание, чтение и удаление файлов;
- назначение и изменение атрибутов файлов;
- защита файлов при системном сбое;
- защита файлов от несанкционированного доступа;
- поиск файлов

- **cat /proc/filesystems** - вывести список файловых систем, которые поддерживаются ядром
- **file -s /dev/sda1** - выводит тип файловой системы
- **df -T** - выводит тип файловой систем

**Extent** - В традиционных файловых системах заголовки(inode) указывают на отдельные блоки. В файловых системах с поддержкой экстентов используются указатели не на блоки, а на экстенты - непрерывные области носителя информации.

**COW(Copy-On-Write - копирование при записи)** - механизм для оптимизации различных процессов в операционных системах. Идея подхода copy-on-write заключается в том, что при чтении области данных используется общая копия, в случае изменения данных — создается новая копия.

<details>
  <summary>Filesystems</summary>
  
**FAT** (File Allocation Table, таблица размещения файлов) – файловая система, которая использовалась в операционной системе DOS. В файловой системе FAT дисковое пространство логического раздела делится на три области: зарезервированная, системная и область данных

**NTFS** (new technology file system, «файловая система новой технологии») — стандартная файловая система для семейства операционных систем Windows NT.

**Ext4** — является развитием Ext2 и Ext3. Самая популярная, “файловая система по умолчанию” в Linux. В отличие от Ext3 введен механизм пространственной (extent) записи файлов, уменьшающего фрагментацию и повышающего производительность.
- mkfs -t ext4 /dev/hdb1 - создания ext4 на разделе /dev/hdb1

**XFS** - высокопроизводительная 64-битная журналируемая файловая система.
- **mkfs.xfs /dev/sda1** - содание файловой системы

**Btrfs** - (B-tree FS) — файловая система для Linux, основанная на структурах B-деревьев и работающая по принципу «копирование при записи» (copy-on-write)
- - mkfs.btrfs /dev/sdc -L single_drive - создание ФС на одном диске
- - mkfs.btrfs /dev/sdc /dev/sdd -L double_drive - оздание ФС на двух дисках
- - mkfs.btrfs /dev/sdc /dev/sdd -d raid1 -m raid1 -L raid1_drive - создать рейд средствами btrfs

**NFS (Network File System, сетевая файловая система)** — протокол сетевого доступа к файловым системам. Позволяет пользователям подключать удаленные сетевые каталоги к своей системе и передавать файлы между серверами.
</details>

- **/etc/fstab** - конфигурационный файл, содержащий инструкции по монтированию блочных устройств, NFS-ресурсов и псевдо-файловых систем в пространство файловых имен и областей подкачки страниц - что монтируем (UUID) куда монтируем (path) тип(ext4) опции(defaults) индикатор необходимости делать резервную копию(0) порядок проверки раздела(1)
- **mount -a** - проверка корректности /etc/fstab

- systemctl list-units -t mount --all - вывести состояние всех описаных в systemd точек монтирования
- systemctl edit --full boot.mount - открыть на редактирование unit-файл
- mount - show all mounted

**Типы файлов в линукс**
- **Обычные файлы** ( - ) (регулярные) – любые текстовые, исполняемые, библиотечные, графические файлы
- **Каталоги** ( d ) – хранят именованные ссылки (только ссылки, но не сами файлы) на другие файлы
- **Символьные ссылки** ( l ) – файл с текстовой строкой, которая представляет собой путь к самому файлу
- **Сокеты** ( s ) и **каналы** ( p ) – файлы, которые используются для взаимодействия между различными процессами
- **Файлы блочных** ( b ) и **символьных** ( c ) устройств – используются для взаимодействия с внешними устройствами

- mkfifo mypipe - создает pipe - канал - можно в него отправлять и из него брать информацию
- Жесткие ссылки - Не является отдельным типом файла, Существует в рамках одной ФС, Представляет собой второе имя файла, Не может указывать на каталог, При удалении уменьшается счетчик жестких ссылок(если 0 - то сам файл)
- Символические ссылки - Является отдельным типом файла, Может ссылаться на другие разделы и ФС, Представляет собой ссылку или ярлык на файл, Может указывать на каталог, При удалении - удаляется файл-ярлык
- **Inode (index-node, индекс-узел, индексный дескриптор)** — структура данных в ФС, в которой хранится метаинформация о файлах каталогах и т.д
- информации в inodes:
  - размер файла;
  - идентификатор (ID) устройства, содержащего файл;
  - ID пользователя-владельца файл;
  - указатели на блоки (кластеры) диска, в которых размещён файл;
  - количество блоков, занимаемых файлом
- В ext2,3,4 - заканчиваются, в xfs, btrfs - они inods динамические
- stat file - информация о файле
- **df -i** - все inods в разделах - сколько используется и сколько осталось
- **ls -i** - inods текущего каталога
- file -s /dev/sda3 - покажет файловую систему раздели и другую информацию о разделе

## Ядро
- **Монолитные ядра** – все функции операционной системы загружены в единый файл и выполняются в качестве одного процесса в одном адресном пространстве.
- **Микроядра** – все функции ядра разделяются на несколько процессов, которые обычно называют серверами. Все серверы поддерживаются независимыми друг от друга и выполняются каждый в своем адресном пространстве.
- **Гибридные ядра** – различные комбинации, совмещающие оба вышеуказанных подхода.

- На сегодняшний день **Linux — монолитное ядро с поддержкой загружаемых модулей**.
- Драйверы устройств и расширения ядра обычно запускаются в нулевом кольце защиты, с полным доступом к оборудованию.
- Все драйверы и подсистемы работают в своем адресном пространстве, отделенном от пользовательского.
- В отличие от обычных монолитных ядер, драйверы устройств легко собираются в виде модулей и загружаются или выгружаются во время работы системы.
- /lib/modules/
- **lsmod** - info about all modules
- insmod - /lib/modules/modulename.ko - load with insmod
- modprobe module-name - load module
- modinfo module-name - info about module
- rmmod module-name

**Подсистемы ядра:**
- **Process Scheduler (SCHED)** — планировщик процессов, отвечает законтроль над доступом процессов к CPU;
- **Memory Manager (MM)** — менеджер памяти, обеспечивает различным процессам безопасный доступ к основной памяти системы;
- **Virtual File System (VFS)** — виртуальная файловая система, создает абстрактный слой, скрывая детали оборудования, предоставляя общий файловый интерфейс для всех устройств
- **Network Interface (NET)** — сетевые интерфейсы, обеспечивает работу с различными сетевыми стандартами и сетевым оборудованием;
- **Inter-Process Communication (IPC)** — межпроцессная подсистема, поддерживающая несколько механизмов для process-to-process связей в единой Linux-системе.

**Планировщик процессов** — основная подсистема. Все остальные зависят от нее, так как всем им необходимо приостанавливать и возобновлять выполнение процессов.
- **Выполнение в режиме ядра** - Передача ядру контроля над процессом для выполнения необходимой задачи. Например, открытие файла или передачи данных по сети. Существует 2 события, при которых выполнение переходит в режим ядра:
- **системные вызовы** - Поступают от пользовательских программ и касаются работы с устройствами, памятью и т.п. Системный вызов — обращение прикладной программы к ядру операционной системы для выполнения какой-либо операции
- **аппаратные прерывания** - Сигнализируют об окончании какого-либо действия со стороны устройства или о возникшей на устройстве ошибке. - Когда CPU получает прерывание, он останавливает любые процессы - Если это не более приоритетное прерывание, тогда обработка пришедшего прерывания произойдет только тогда, когда более приоритетное будет завершено. - Сохраняет некоторые параметры в стеке. - Вызывает обработчик прерывания

**Dynamic Kernel Module Support (DKMS)** — это фреймворк, который используется для генерации тех модулей ядра Linux, которые в общем случае не включены в дерево исходного кода.
- **DKMS позволяет драйверам устройств автоматически пересобираться, когда ядро уже установлено**. Пользователь может не ждать, пока какая-то компания, проект или сопроводитель пакета выпустит новую версию модуля. Значительное число модулей, не включенных в ядро, имеют DKMS вариант; некоторые из них размещаются в официальных репозиториях.

## Загрузка
**Загрузка (boot, booting)** — процесс запуска устройства и загрузки ОС. В этот момент происходит обнаружение и (само)настройка всех компонентов системы

**Этапы загрузки**
- Загрузка BIOS/UEFI (MBR/GPT).
- Поиск, загрузка в память и запуск загрузчика (GRUB).
- Поиск, загрузка в память и запуск ядра ОС.
- Запуск системных служб.
- Запуск пользовательских служб.

https://vc.ru/dev/137548-pusk-v-detalyah-kak-zagruzhaetsya-server

**BIOS (Basic Input/Output System)** — набор системных программ (firmware), используемых для процесса проверки и инициализации аппаратного обеспечения с последующим запуском загрузчика ОС.

**POST (power-on self-test)** — процесс первоначальной проверки оборудования сразу после его включения

**Процесс загрузки BIOS**
- Инициализация видеокарты (как option BIOS);
- Запуск и выполнение POST;
- Поиск загрузчика ОС на доступных устройствах (проверка сигнатуры загрузочного диска);
- Передача управления на найденный загрузочный сектор.

**UEFI, Unified Extensible Firmware Interface (интерфейс расширяемой прошивки)** — спецификация интерфейса между ОС и аппаратными прошивками (firmware), UEFI, в отличии от BIOS, содержит свой собственный загрузчик — UEFI Boot Manager
- SEC (Security) — проверяет цифровые подписи и передает управление доверенному коду.
- PEI (Pre EFI Initialization) — инициализация устройств.
- DXE (Driver eXecution Environment) — загрузка сервисов UEFI.
- BDS (Boot Device Select) — поиск устройств загрузки.
- RT (Run Time) — GRUB.

**GRand Unified Boot (GRUB)** — стандарт де-факто для загрузчиков Linux. Основное назначение: загрузка ядра ОС и выбор параметров загрузки.
- Настройка GRUB - grub.cfg - Внесение изменений в конфигурацию GRUB - /etc/default/grub - подтверждение - update-grub/grub2-mkconfig
- cat /proc/**cmdline** - Параметры ядра
- BOOT_IMAGE — образ ядра, которое загружено в данный момент
- root — корневая ФС
- vt.handoff — параметр специфичный для Ubuntu, нужен для сокрытия вывода загрузчика
- sysctl -a - Просмотр параметров ядра
- cat /etc/sysctl.conf | more - config file - Просмотр конфигурационного файла

**Initrd (Initial RAM Disk)** — образ, содержащий модули для инициализации ядра. GRUB передает ядру данный образ как параметр загрузки, поэтому, следует обратить внимание на то, что файл initrd должен соответствовать загружаемому ядру. Если ядро содержит все необходимые модули, то файл initrd не нужен.

**init** — специальный процесс (демон) управления системой и службами - Режимы работы init - однопользовательский (службы не запускаются), многопользовательский (режим запуска по умолчанию), сервер (аналогичен многопользовательскому, но без GUI)
- /sbin/init - Расположение init

**Варианты init**
- System V (SysV) - Все службы запускаются последовательно
- BSD init - FreeBSD, NetBSD, OpenBSD
- systemd - упрощенный процесс загрузки, параллельный запуск служб, запись событий в системный журнал.

https://wiki.merionet.ru/articles/3-varianta-inicializacii-operacionnoj-sistemy/

**Процесс запуска Init-V**
- GRUB загружает и запускает ядро;
- ядро запускает /sbin/init;
- init разбирает /etc/inittab и выполняет сценарий для инициализации системы;
- init выполняет скрипт /etc/rc.d/rc или /etc/init.d/rc;
- скрипты из /etc/rcn.d или /etc/init.d/rcn.d запускают различные службы.

**systemd** — современный менеджер управления службами Linux. Позволяет выполнять следующие действия со службами: запускать/останавливать; добавлять/удалять; редактировать; собирать логи.
- Цель (target) — нужное состояние системы; ссылка на файл, содержащий зависимости (службы) Systemd запускает все зависимости из соответствующего target файла. Когда все зависимости будут запущены, то система будет работать на соответствующем target-уровне
- systemctl get-default - проверка target - (graphical.target)
- Модуль (unit) — описывает запускаемую службу, устройство и т.п.
  - Каждый модуль описан в своем файле (unit file):
  - /usr/lib/systemd/system/ – модули из пакетов (Nginx, Apache, MySQL)
  - /run/systemd/system/ — модули, созданные во время работы ОС
  - /etc/systemd/system/ — модули, созданные пользователем.
- **Типы модулей**
  - модули служб — обычные службы ОС
  - модули монтирования — монтируют ФС
  - целевый модули/цели — группируют другие модули
- systemctl list-units — список модулей
- systemctl list-units --type=service — список модулей-служб
- journalctl - Журнал — база данных, в которой хранятся сообщения ядра и служб, начиная с загрузки и заканчивая завершением работы
- nano /etc/systemd/journald.conf - Настройки журнала
- jurnalctl -u=sshd — сообщения для модуля ssh
- journalctl --since=yesterday --until=now - временной период

## Дистрибутивы
**Дистрибутив** – это форма распространения системного программного обеспечения. Дистрибутив обычно содержит программы для начальной инициализации системы (инициализация аппаратной части, загрузка урезанной версии системы и запуск программы-установщика), программу-установщик (для выбора режимов и параметров установки) и набор специальных файлов, содержащих отдельные части системы (пакеты, сюда входит ядро, прикладные приложения и т.д.). Программа установки позволяет установить и произвести первичную настройку системы.

**Из чего состоит дистрибутив?**
- ядро;
- система инициализации;
- предустановленный и доступный набор ПО;
- графическая оболочка по умолчанию;
- пакетный менеджер;
- исправления и другое ПО от разработчиков дистрибутива.

## Управление пакетами
**Репозиторий** — хранилище данных, в данном случае — пакетов ПО.

**Менеджер пакетов** – специальное программное обеспечение, которое управляет загрузкой, установкой, удалением пакетов, а также решением зависимостей. Наиболее популярными менеджерами пакетов являются APT (семейство Debian) и YUM (семейство Red Hat)

**Пакет** – это архив специального формата, который содержит:
- все необходимые приложению бинарные и конфигурационные файлы;
- информацию о том, как их следует разместить в файловой системе;
- данные о зависимостях пакета;
- список действий, которые необходимо выполнить в процессе установки.

**Зависимости** - Практически любая достаточно объемная программа требует для своей работы дополнительные библиотеки и компоненты. Такие дополнительные материалы, необходимые для работы приложения, устанавливаемого из пакетов, называют зависимостями. Современные пакетные менеджеры решают эту проблему благодаря описанию зависимостей в пакете

**Сторонние репозитории** - Иногда крупные разработчики программного обеспечения (яркий пример – PHP) не хотят выкладывать свои приложения в базовые репозитории того или иного дистрибутива, а вместо этого организовывают свои собственные репозитории, в которых хранят пакеты, доступные для установки на разные дистрибутивы Linux. Такие репозитории называют сторонними.

**Подключение сторонних репозиториев** - Для того чтобы иметь возможность устанавливать ПО из сторонних репозиториев, их надо указать в sources.list вашего пакетного менеджера и скачать gpg-ключ для него.

**Компиляция пакета из исходников** - В современном мире не всегда приложение упаковывается в готовый пакет. Самые последние версии ПО, к примеру, зачастую распространяются в форме исходного кода.

**Команда make** - Для сборки нам нужны компиляторы: они прописаны в зависимостях пакета build-essential, так что достаточно установить его со всеми зависимостями. Ещё нужны autoconf и automake. Убедитесь в наличии файла configure, необходимого для процесса сборки. Для его генерации надо выполнить: ./bootstrap или ./autogen.sh.
- **make** – сборка пакета, установка в нем нужных параметров и подготовка к установке.
- **make install** – устанавливает сконфигурированное приложение в систему.
- **checkinstall** – программа для сборки .deb-пакета дистрибутива Ubuntu. Использование этой программы не всегда работает по причине отсутствия описания в исходниках у некоторых программ.
- **dpkg-deb --build** – более надежный вариант создания пакета в дистрибутиве Debian.
- **rpmbuild** – программа для сборки .rpm-пакета.

Для создания пакета необходимо иметь готовый spec-файл (control для .deb), который описывает пакет, его зависимости, имя, описание и так далее.
Собранный пакет дальше устанавливается при помощи менеджера пакетов.

**Пример сборки пакета на Debian**
- Скачать исходные файлы приложения.
- Создать файл, описывающий пакет spec для .rpm, control для .deb.
- Выполнить dpkg-deb --build <source_dir> Удобнее всего это сделать, поднявшись на уровень выше в иерархии каталогов.
- Установить получившийся пакет при помощи пакетного менеджера.

**APT (advanced packaging tool)** — программа для установки, обновления и удаления программных пакетов в операционных системах Debian и основанных на них (Ubuntu, Linux Mint и т. п.). Способна автоматически устанавливать и настраивать программы для UNIX-подобных операционных систем как из предварительно откомпилированных пакетов, так и из исходных кодов.

**YUM (Yellowdog Updater, Modified)** — открытый консольный менеджер пакетов для дистрибутивов Linux, основанных на пакетах формата RPM (RedHat, CentOS, Fedora, Oracle Linux). Как и APT, менеджер YUM работает с репозиториями пакетов от производителя дистрибутива или от сторонних авторов, также способен автоматически устанавливать и настраивать программы.

## Инициализация системы. Init, Systemd
**init** — специальный процесс (демон) управления системой и службами. Расположение: /sbin/init

**Режимы работы init:**
- однопользовательский (службы не запускаются);
- многопользовательский (режим запуска по умолчанию);
- сервер (аналогичен многопользовательскому, но без GUI).

**Варианты init**
- System V: Все службы запускаются последовательно.
- BSD init: FreeBSD, NetBSD, OpenBSD.
- systemd: упрощенный процесс загрузки; параллельный запуск служб; запись событий в системный журнал.

**Процесс запуска Init-V**
- GRUB загружает и запускает ядро;
- ядро запускает /sbin/init;
- init разбирает /etc/inittab и выполняет сценарий для инициализации системы;
- init выполняет скрипт /etc/rc.d/rc или /etc/init.d/rc;
- скрипты из /etc/rcn.d или /etc/init.d/rcn.d запускают различные службы.

**Уровни запуска Init-V**
- остановка работы с выключением;
- (S) — однопользовательский режим;
- многопользовательский режим без выхода в сеть;
- многопользовательский режим с сетью, но без запуска X;
- обычно не применяется;
- многопользовательский режим с сетью и запуском X (по умолчанию);
- остановка работы компьютера с перезагрузкой.
- **who -r** - Определение уровня запуска

**Определение типа init**
- Systemd — если в системе есть каталоги /usr/lib/systemd и /etc/systemd;
- Upstart — если каталог /etc/init содержит несколько файлов с расширением .conf, можно выполнить команду initctl;
- System V init — если ни один из приведенных вариантов не подходит, однако есть файл /etc/inittab.
- file /sbin/init

**Модуль (unit)** — описывает запускаемую службу, устройство и т.п.
Каждый модуль описан в своем файле (unit file):
- /usr/lib/systemd/system/ – модули из пакетов (Nginx, Apache, MySQL);
- /run/systemd/system/ — модули, созданные во время работы ОС;
- /etc/systemd/system/ — модули, созданные пользователем.

**Типы модулей**
- модули служб — обычные службы ОС;
- модули монтирования — монтируют ФС;
- целевый модули/цели — группируют другие модули;

**Цель (target)** — нужное состояние системы; ссылка на файл, содержащий зависимости (службы).
- Systemd запускает все зависимости из соответствующего target- файла.
- Когда все зависимости будут запущены, то система будет работать на соответствующем target-уровне
- **man bootup** - Иерархия целей

**Модули служб**
systemctl --all -t service - Просмотр всех служб
systemctl status sshd.service - Просмотр выбранной службы (ssh)
cat /etc/systemd/system/multi-user.target.wants/ssh.service - Пример модуля

**Раздел Unit**
Description=OpenBSD Secure Shell server — описание службы
After=network.target auditd.service — запуск после (after) этой службы
ConditionPathExists=!/etc/ssh/sshd_not_to_be_run — условная зависимость

**Шаблон** - специальный unit-файл, позволяющий systemd работать снесколькими экземплярами unit.
Для вызова шаблона использует специальный формат: <имя_службы>@<аргумент>.service

## Управление пользователями
- **root** (superuser, суперпользователь) – обязательный пользователь во всех Linux. Root может прочитать, удалить или изменить любой файл (следовательно и всё) в системе. Для root: UID = 0, GUID = 0, домашний каталог = /root
- **sudo** – временное повышение прав текущего пользователя до root.
- **/etc/sudoers** – список пользователей или групп, которым разрешено использовать sudo
- id - показывает uid, guid, и все группы в которых пользователь
- **/etc/passwd** – файл, содержащий список пользователей системы
- **/etc/shadow** – файл, содержащий список паролей пользователей
- **/etc/group** – файл, содержащий список групп пользователей
- **/etc/sudoers** - файл, содержащий список суперпользователей
- Для редактирования применяется команда visudo
- root ALL=(ALL:ALL) ALL – root может запускать любую команду в любой группе на любом хосте;
- %admin ALL=(ALL) ALL – аналогично для группы admin.

**User**
- **cat /etc/default/useradd** - файл для созданию пользователя - можно поменять домашнюю директорию, bash, или папку /etc/skell - для наполнения дом каталога по умолчанию
- useradd -D - отображает значения для пользователя по умлочанию
- useradd xakep - создание пользователя
- su xakep - зайти под пользователем xaker - удобно с пользователями службами (без пароля)
- usermod --lock xakep - блокировка пользователя
- passwd xakep - сменя пароля
- userdel xakep - удаление

**Groups**
- groupadd ctf - создание группы
- groupmod -n ctf ftc - переименование группы
- groupdel ftc - удаление группы

**Права доступа**

**Специальные биты**
- Setuid (suid) – позволяет пользователю выполнять программу с правами владельца (s в атрибутах файла).
- Setgid (sgid) – работает аналогично setuid, но для группы.
- Sticky – в таком каталоге пользователь может удалять только свои файлы (t в атрибутах файла).
Для большей безопасности при монтировании ФС можно указать параметр nosuid для отключения флагов suid и setgid.

- **chmod (change mode)** – утилита для изменения прав доступа
- **chown (change owner)** – утилита для изменения владельца файла
- **chgrp (change group)** – утилита для изменения групп

**Переменная $PATH (путь)** – список каталогов, разделенных символом «;»
- echo $PATH - Просмотр $PATH

**Основные переменные окружения**
- HOME=/home/user – домашний каталог пользователя;
- LOGNAME=user – имя пользователя в текущей оболочке;
- PWD=/home/user – текущий рабочий каталог;
- SHELL=/bin/bash – командная оболочка;
- LC_*=ru_RU.UTF-8 – переменные для локализации;
- LANG=en_US.UTF-8 – язык системы.

## Производительность системы
**Производительность системы** – количественные характеристики скорости выполнения определенных операций устройств и программ таких как:
- ядро операционной системы;
- процессы и программы;
- оперативная память;
- центральные процессоры;
- накопители информации.

**Ядро операционной системы**
- обрабатывает прерывания от устройств;
- выполняет запросы системных процессов и пользовательскихприложений;
- распределяет виртуальную память;
- создает и уничтожает процессы;
- обеспечивает многозадачность посредством переключениямежду ними;
- содержит драйверы устройств;
- обслуживает файловую систему.

**Процесс программы** в ядре представляется просто как структура с множеством полей:
- идентификатор процесса (pid);
- открытые файловые дескрипторы (fd);
- обработчики сигналов (signal handler);
- текущий рабочий каталог (cwd);
- переменные окружения (environ);
- код возврата.

**Оперативная память** - Влияет на производительность системы в целом, так как программы при запуске сохраняются в ней. Кроме этого если не присутствует нехватка оперативной памяти, то это приводит к постоянному кэшированию памяти на накопитель в раздел SWAP.

**Центральные процессоры**
Элемент системы который отвечает за обработку операций.
Характеристики влияющие на производительность:
- архитектура;
- кэш память процессора;
- скорость шины передачи данных;
- множитель частот;
- число потоков;
- число ядер процессора

**Накопители информации**
Компонент системы нужный для хранения информации;
- все программы как и операционная система, так и ядро загружается с накопителя;
- чем быстрее шина, чем быстрее чтения и запись данных, тем производительней система;
- на производительность также может влиять использование технологии RAID

**Утилиты мониторинга производительности**
- top – вывод список работающих в системе процессов и информацию о них;
- atop – продвинутый интерактивный полноэкранный мониторпроизводительности;
- mpstat – выводит статистику по процессору;
- iostat – мониторит использования дисковых разделов;
- pidstat – выводит статистику по процессам;
- vmstat – выводит статистику процессора, памяти и о процессах;
- lvm – инструмент для работы LVM;
- mdraid – программа для работы с массивами дисков.

**sysstat** – это набор инструментов мониторинга производительности для Linux

В состав пакета входят следующие утилиты:
- mpstat - отчет о использовании процессоров
- pidstat - используется для мониторинга процессов в режиме реального время
-  -t – выводит на экран информацию в виде дерева; Например: pidstat -t -C “mysql”.
- vmstat - предоставляет краткую информацию о различных ресурсах системы и связанных с ними неполадках, приводящих к снижению производительности
- iostat - мониторинг использования дисковых разделов

## Производительность системы 2

Операционная система при своей работе сохраняет всю информацию работы устройств в директории **/proc**. Устройство в системе рассматривается как блочное устройство с системой ввода и вывода. Устройства, как правило, рассматриваются файлом через который можно считывать или куда можно записывать информацию. Находится данные файлы в директории **/dev**. Как видно из примера, некоторые файлы ссылаются на директорию **/proc**.

**Накопители информации** - Компонент системы нужный для хранения информации. Все программы: как и операционная система, так и ядро, – загружается с накопителя. Чем быстрее шина, чем быстрее чтения и запись данных тем производительней система. Кроме этого на производительность может влиять использование технологии RAID.

**RAID** (Redundant Array of Independent Disks, избыточный массив независимых дисков) — технология виртуализации данных, которая объединяет несколько дисков в логический элемент для повышения производительности и отказоустойчивости

**Методы для ускорения системы**
- **Cron** – планировщик заданий, используемый для планирования выполнения команд на определённое время.
- Работа с памятью компьютера (автомато чистить не нужные файлы)
- Работа с логами установок/обновлений (автоматом чистить логи и файлы обновлений)

**cpufreq** - В сборки различных систем входит пакет cpufreq, который отвечает за управлением питания процессора. Просмотреть значения частоты процессора: cat /proc/cpuinfo
Установочные ключи для работы демона:
- Ключ powersave – говорит энергосбережение
- Ключ performance – выставляет максимальное значение

**Ускорение swap** - Бывает так что оперативной памяти достаточно много, но по какой-то причине задействуется swap. Исправить данную историю можно изменив параметры ядра:
- sudo sysctl vm.swappiness= x
- sudo sysctl -p - применим данные настройки в ядро системы 

Утилиты мониторинга производительности
- iostat – мониторит использования дисковых разделов;
- vmstat – выводит статистику процессора, памяти и о процессах;
