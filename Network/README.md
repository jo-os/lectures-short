# OSI
# L2-сеть

**Канальный уровень (Data Link layer)** - это второй уровень в модели OSI, определяет способы передачи данных между устройствами, находящимися в одном сегменте сети

**Решаемые проблемы**
- Обнаружение ошибок физического уровня
- Одновременная передача данных разным устройствам
- Аппаратная адресация

**Сегмент сети** - логически или физически обособленная часть сети

**Трафик в сети:**
- Broadcast трафик - от одного хоста ко всем хостам в сети - используют для служебного трафика
- - Определения нужного адреса
- - Получения настроек
- - Поиска сервера DHCP
- Unicast трафик - от одного хоста к другому хосту - используют для обмена данными по клиент-серверной модели
- Multicast трафик - от одного хоста к некоторой ограниченной группе хостов - используют для рассылки сообщений ограниченной группе

**Виды сред передачи данных**
- Общая среда - метод реализации сетей, когда все устройства имеют доступ к среде передачи данных, используя ее одновременно для приема и передачи
- Коммутируемый доступ - метод построения сетей на основе выделения каналов приема-передачи от конечных устройств к коммутаторам, которые обеспечивают маршрутизацию данных на основе адреса получателя

**Стандарты связи**
- Полудуплексный режим - один и тот же канал может использоваться или для передачи или для приема, но не одновременно
- Дуплексный режим - приём и передача могут осуществляться одновременно за счет физического разделения соответствующих каналов

**Домен коллизий** - часть сети Ethernet, все узлы которой конкурируют за общую разделяемую среду передачи и, следовательно, каждый узел которой может создать коллизию с любым другим узлом этой части сети

**Широковещательный домен** - метод доставки сообщений, при котором сообщение получают сразу все участники обмена (связи)

**Протокол Ethernet IEEE 802.3**
- Протоколы канального уровня отвечают за доставку данных внутри одного сегмента сети
- Сегмент сети (согласно IEEE 802.3) электрически соединенные устройства, использующие общую среду

**MAC-адрес (Media Access Control)** - аппаратный номер оборудования (компьютера, сервера, порта коммутатора и прочее), который присваивается сетевой карте в момент его производства

**MTU (Maximum Transmission Unit)** - максимальный размер полезного блока данных одного пакета (англ. payload), который может быть передан протоколом без фрагментации

**Address Resolution Protocol** - Протокол определения адреса - протокол в компьютерных сетях, предназначенный для определения IP-адреса по известному MAC-адресу узла и наоборот

**Двухуровневая адресация** - необходима для глобальной адресации узлов интернет сети, при этом каждый узел имеет уникальный локальный адрес внутри своей сети и каждая сеть имеет свой идентификатор

**Tcpdump** - утилита, позволяющая перехватывать и анализировать сетевой трафик, проходящий через компьютер, на котором запущена данная программа

**STP (Spanning Tree Protocol)** - Протокол остовного дерева - канальный протокол, основной задачей которого является устранение петель в топологии произвольной сети Ethernet

**LAN (Local Area Network)** - локальная компьютерная сеть, соединяющая компьютеры на небольшой территории, такой как офисные здания, университеты, здания

**VLAN (Virtual Local Area Network)** - Виртуальная локальная вычислительная сеть - логически обособленный сегмент локальной сети внутри одной физической сети. VLAN - технология, которая позволяет строить виртуальные сети с независимой от физических устройств топологией

# L3-сеть

**Сетевой уровень** - это третий уровень в модели OSI, который определяет способы передачи данных между устройствами, находящимися в разных сетях (сегментах сети)

Решаемые проблемы:
- Логическая адресация
- Построение маршрутов между сетями
- Диагностика сети

**Маска подсети** - битовая маска для определения по IP-адресу адреса подсети и адреса узла (хоста, компьютера, устройства) этой подсети

**IP (Internet Protocol)** - создан для использования во взаимосвязанных системах компьютерных сетей с коммутацией пакетов

Назначение IPv4
- Логическая адресация хостов на основе IP-адреса
- Инкапсуляция данные вышестоящих протоколов
- Маршрутизация данных между хостами
- Фрагментация IP-пакетов

Ограничения IPv4
- не устанавливает соединения
- не гарантирует доставку
- не обеспечивает обеспечения сохранение последовательности данных при передаче
- не устраняет возможное дублирования пакетов

**CIDR (Classless Inter-Domain Routing)** - метод IP-адресации, позволяющий гибко управлять пространством IP-адресов, не используя жёсткие рамки классовой адресации, возможно применение различных масок подсетей к различным подсетям

**Маска сети** - количество бит в адресе, которое отведено под адрес сети

**Адрес сети** (192.168.0.0) - позволяет определить, что хосты находятся в одной сети

**Широковещательный адрес сети** (192.168.0.255) - пакеты с широковещательным адресом получат все хосты этой сети

**IPv6** - новый стандарт протокола IP, призванный исправить недостатки IPv4

**Преимущества IPv6**
- Увеличенное адресное пространство (128 бит)
- Автоконфигурация (не нужно настраивать адреса вручную)
- Jumbogram (передача до 4 Гб данных в одном пакете)

**IPv6 трафик может быть:**
- Unicast - Обычный трафик хоста
- Anycast - Групповой трафик, пакет будет доставлен наиболее близкому хосту с точки зрения протокола маршрутизации
- Multicast - Групповой трафик, пакеты будут доставлены каждому хосту в группе
- Broadcast - Не реализован

**Задача маршрутизатора** - объединение сетей на сетевом уровне. При работе маршрутизатор вынужден подменять MAC- адрес запроса на свой собственный MAC-адрес в другом сегменте

**Статическая маршрутизация** - вид маршрутизации, при котором маршруты указываются в явном виде при конфигурации маршрутизатора. Вся маршрутизация при этом происходит без участия каких- либо протоколов маршрутизации

**Динамическая маршрутизация** -  вид маршрутизации, при котором таблица маршрутизации редактируется программно

**TTL (Time To Live)** - время жизни пакета данных в протоколе IP (предельно допустимое время его пребывания в системе). Данное свойство используется в traceroute. Используя src IP и метки времени, traceroute узнает трассу прохождения пакета и время его прохождения

# L4-сеть

**Транспортный уровень** - Определяет способы доставки данных, то есть сам механизм передачи данных

**Решаемые проблемы:**
- Мультиплексирование - может работать с несколькими потоками данных между двумя устройствами
- Надежная передача данных
- Регулирование количества передаваемых данных
- Контроль доставки данных

**Единицы и протоколы:**
- TCP - сегмент
- UDP - дейтаграмма

**TCP (Transmission Control Protocol - протокол управления передачей)** - Передает данные между приложениями (например, интернет-браузер) и web-службами

Назначение протокола TCP:
- Надежная доставка данных - осуществляется автоматической повторной пересылкой пропавших сегментов
- Сборка сегментов на стороне получателя - TCP получателя собирает пакеты как надо, если они пришли не в "правильном" порядке
- Контроль сессии - Перед началом передачи данных, TCP всегда проверяет, что получатель существует и готов принимать данные
- Контроль скорости передачи данных - Отправитель может динамически менять размер пересылаемых данных, анализируя подтверждения от получателя, благодаря механизму скользящего окна
- Мультиплексирование - процедура приема данных протоколами TCP и UDP, поступающих от нескольких различных прикладных служб

**Трехстороннее рукопожатие** - процесс установки надежного, полнодуплексного соединения, где оба канала могут передавать информацию одновременно, а также они синхронизируют и подтверждают друг друга (готов общаться - готов - начинаю говорить)

**Техника скользящего окна** -  особенность протокола TCP, которая используется для подбора оптимального количества отправляемых пакетов с сохранением надежной упорядоченной доставки пакетов, а также используется для повышения эффективности, когда канал может иметь большую задержку. TCP постоянно анализирует время прохождения подтверждений и адаптирует размер окна под пропускную способность

**Заголовок TCP** - служебная информация (метаданные), которая добавляется к полезной нагрузке (payload) на транспортном уровне для решения всех задач протокола TCP
- Номер портов получателя и отправителя
- Порядковый номер, Номер подтверждения
- Длина самого заголовка TCP
- Размер окна
- Признак важности данного сегмента
- ASK - содержит значение номера подтверждения в поле подтверждения\
- PSH - получатель передает данные из буфера в приложение и сразу же отправляет сообщение с подтверждением
- RST - сбрасывает соединения
- SYN - создает соединения
- FIN - завершает соединения

**Мультиплексирование** - процедура приема данных протоколами TCP и UDP, поступающих от нескольких различных прикладных служб
- Для того, чтобы понимать какой процесс посылает или принимает данные, применяется метод определения конечной точки транспортного уровня
- Порт - адрес транспортного уровня
- Номер порта - идентификатор приложения на хосте получателя и/или отправителя
- 0 - 1023 - общеизвестные / системные
- 1024 - 49151 - зарегистрированные / пользовательские - Зарегистрированные программы или протоколы
- 49152 - 65535 - динамические / частные - Создания исходящих соединений с различными сервисами

**Сетевой сокет** - структура, которая определяет конечную точку во время сетевого обмена данными

Для TCP/IP сокетом является сочетание трех параметров сессии
- Транспортного протокола (TCP, UDP)
- Номера порта
- IP-адреса

**Парные сокеты** - локальный и соответствующий удаленный сокеты (Парный сокет имеет вид T.55000:IP1<->80:IP2)

**Типы сокетов по подключению**
- Потоковый (TCP)
- Сокет дейтаграмм (UDP)
- Сырой (raw) сокет (IP-пакет с данными)

**Установление соединения** - процесс обмена между двумя удаленными точками, в результате которого стороны начинают обмен информацией. Протокол TCP устанавливает соединение с помощью трехстороннего рукопожатия

![tcp](https://github.com/joos-network/OSI/blob/main/tcp.png)

Нормальное завершение TCP-соединения происходит в виде двухстороннего рукопожатия
- Оба хоста закрывают свои сокеты
- Освобождают занятые во время сеанса ресурсы

![tcpclose](https://github.com/joos-network/OSI/blob/main/tcpclose.png)

**RST** - флаг прерывания соединения, используется для отказа в соединении 
**Флаг RST** – сброс - Если этот флаг установлен в 1 Хост должен немедленно прекратить обмен и закрыть со своей стороны сокет. Данный механизм нужен для уведомления противоположной стороны о произошедшем сбое

**Протокол UDP (User Datagram Protocol — протокол пользовательских датаграмм)**
- «Рабочая лошадка» всех потоковых сервисов и геймдева
- Обеспечивает работу современных цифровых сервисов
- Основа DNS

**Назначение протокола UDP**
- Ориентирован на транзакции (запрос – ответ), например, DNS или NTP
- Простой протокол, для которого не требуется сложная модель обмена данными
- Не сохраняет состояния соединения – подходит для рассылки большому количеству хостов (IPTV)
- Отсутствуют повторные передачи, что позволяет работать в режиме реального времени (игры)
- Поддерживает многоадресную рассылку (Precision Time Protocol and Routing Information Protocol)

**Заголовок протокола UDP**
- Номер портов получателя и отправителя
- Длина
- Контрольная сумма

**Multicast** - режим передачи данных, в котором данные передаются группе хостов

**Преимущество многоадресного вещания** - Часть информации для разных клиентов передается один раз по «общему» маршруту = Снижается нагрузка на пропускную способность сети (Потоковое аудио и видео, Интернет-телевидение)

**DNS** - система, предназначенная для получения информации о доменах

**Режим работы DNS** - Запрос – ответ = обмениваясь короткими сообщениями

**Telnet** - одна из самых популярных утилит для проверки «открытости» TCP порта

**Nmap** - одна из самых популярных утилит для сканирования хостов в сетях – как внутренних, так и внешних – на открытые порты

**SS (Socket statistics)** - наиболее актуальная утилита для сбора информации о сокетах, в частности сетевых сокетах

**Lsof** - мощная утилита, в том числе для получения информации по сети, Lsof поможет узнать, какому процессу принадлежит прослушиваемый порт (sudo lsof -ni :10050 = zabbix-agent)


# firewall-nat-vpn
# Firewall

**Задача Firewall** - фильтрация проходящего через него трафика на основе определенных ранее правил. Это Защита сетей или отдельных хостов от атак, направленных извне внутрь защищаемой сети

**Netfilter** - межсетевой экран, встроенный в ядро Linux, начиная с версии 2.4

**iptables** - утилита Netfilter - Можно создавать и изменять правила, которые фильтруют трафик - является полноценным инструментом позволяющим настроить фаерволл

**firewalld** - Аналог iptables - В операционных системах CentOS, Fedora, OpenSUSE, Red Hat Enterprise Linux, SUSE Linux Enterprise

Архитектура Netfilter
- Подразумевает прохождение пакетов через цепочки правил
- Каждое правило содержит различные критерии и действие или переход, выполняющиеся в случае полного соответствия пакета критериям 
- Отсутствие критериев применяет правило ко всем проходящим через него пакетам

Cостав правила iptables
- Условие - Логическое выражение на основании которого происходит анализ свойств пакета / соединения и которое определяет попадание пакета / соединения под текущее правило
- Действие - Выполняется в случае соответствия пакета / соединения текущему правилу
- Счетчик - Учитывает количество пакетов попавших под условие текущего правила

**Цепочки iptables** - упорядоченная последовательность правил
- Пользовательская цепочка - Создаётся пользователем и используется только в пределах своей таблицы
- Базовая цепочка - Создаётся по умолчанию при создании таблицы и в отличии от пользовательской обладает действием по умолчанию

**Базовые цепочки iptables** - PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING

**Таблица iptables** - совокупность базовых и пользовательских цепочек, имеющих общее назначение

**Conntrack (англ. отслеживание соединения)** - специальная подсистема, отслеживающая состояния соединений и позволяющая использовать эту информацию при принятии решений о судьбе отдельных пакетов

**Состояния соединений**
- NEW - пакет является первым в соединении
- ESTABLISHED - пакет относится к уже установленному соединению
- RELATED - пакет открывает новое соединение, логически связанное с уже установленными
- INVALID - установить принадлежность пакета не удалось
- UNTRACKED - отслеживание состояния соединения для данного пакета было отключено

**Host** - любое устройство подключенное к сети TCP/IP, принимающее или создающее подключения

**Localhost** - с помощью специального сетевого интерфейса «внутренней петли» (loopback) позволяет создавать сети, состоящие из одного компьютера

Цепочки iptables:
- Цепочка PREROUTING - Предмаршрутная обработка - Обрабатываются все входящие пакеты - Содержатся правила, обработка которых идет до решения о дальнейшей маршрутизации пакета (локальному процессу или другой машине в сети)
- Цепочка INPUT - Входящие пакеты - Обрабатываются входящие пакеты, адресованные локальному процессу
- Цепочка FORWARD - Пересылка пакетов - Обрабатываются входящие пакеты, которые пересылаются дальше
- Цепочка OUTPUT - Исходящие пакеты - Предназначена для пакетов, исходящих от внутренних процессов
- Цепочка POSTROUTING - Постмаршрутизация - Происходит окончательная обработка исходящих пакетов

**Утилита netstat** - позволяет смотреть состояния соединений, таблиц маршрутизации, чисто сетевых интерфейсов и статистику по протоколам
- **netstat -l** - Посмотреть все сокеты с состоянием LISTEN
- **netstat -s** - Узнать статистику для каждого протокола

Шаблон работы с iptables
- iptables [-t table] command [match] [target/jump]
- -t – указывает на таблицу (raw, mangle, nat, security), по умолчанию без указания параметра выбирается таблица filter
- [match] – задает критерии проверки, по которым определяется подпадает ли пакет под действие этого правила или нет
- [target] – указывает, какое действие должно быть выполнено при условии выполнения критериев в правиле

При начальной настройке всегда нужно задавать политику обработки пакетов по умолчанию для каждой цепочки
- sudo iptables -P INPUT DROP
- sudo iptables -P FORWARD DROP

Команда для просмотра таблиц iptables
- sudo iptables -nvL -t raw
- sudo iptables -nvL -t mangle
- sudo iptables -nvL -t nat
- sudo iptables -nvL -t filter

# NAT

**Частные IPv4-адреса** не являются уникальными и могут использоваться во внутренней сети

whois $(curl ifconfig.me) - узнать информацию whois

Блоками частных адресов являются
- 10.0.0.0/8 от 10.0.0.0 до 10.255.255.255
- 172.16.0.0/12 от 172.16.0.0 до 172.31.255.255
- 192.168.0.0/16 от 192.168.0.0 до 192.168.255.255

Способы выхода в интернет с приватных адресов
- Использование сервера PROXY
- Подмена адресов NAT

**Network Address Translation** -  Преобразование сетевых адресов

**NAT** - специальный механизм, реализованный в сетях TCP/IP, который позволяет изменять IP-адреса и/или номера портов TCP/UDP в пересылаемых пакетах

**Виды NAT**
- Static NAT / One to one NAT
- Dynamic NAT
- Source NAT / NAT Overload / Masquerade / Many to one
- Destination NAT (PAT)

**Преимущества NAT**
- Под одним внешним IPv4 адресом может сидеть в глобальной паутине множество пользователей одновременно
- Скрывает ваш настоящий внутренний IP в частной сети и показывает лишь внешний. Так, все устройства из вне видят только ваш общедоступный IP
- В определенной степени выполняет функции фаервола – если на устройство с NAT извне приходит пакет, который не ожидался — то он категорически не будет допущен

**Недостатки NAT**
- Невысокая скорость передачи данных для протоколов реального времени, например, для VoIP. Когда NAT переделывает заголовки пакета — происходят задержки
- Проблемы с идентификацией – под одним IP может находится сразу несколько человек.
- Сервис может заблокировать внешний IP-адрес из-за злоумышленника (который, например, подбирает пароли), а работать перестанет у всех, кто закрывается этим адресом

**Static NAT** -  сопоставление локального IP-адреса с глобальным IP- адресом на основании один к одному

**Static NAT** - используется при необходимости «опубликовать» внутренний сервер компании в интернет, причём не один, а все сервисы сразу. Несмотря на то, что у сервера «серый» адрес, он
полноценно отвечает на запросы извне (по другому, «белому» адресу)

**Dynamic NAT** - динамическая адресная трансляция, в которой адреса сопоставляются по принципу «многие ко многим». Реальные адреса выдаются динамически каждому нуждающемуся пользователю во внутренней сети, а не одному определенному узлу. Dynamic NAT – используется редко

**Механизм Source NAT (SNAT)** - позволяет изменить исходный IP-адрес сетевого пакета на другой IP-адрес, а также увеличить безопасность и сохранить конфиденциальность, поскольку маскируются и скрываются частные IP-адреса устройств

**Source NAT** -  используются для выхода в интернет группы компьютеров с внутренними адресами через один внешний адрес. Снаружи на внешний адрес пропускаются только пакеты, содержащиеся в таблице трансляций

**NAT Masquerading** -  тип трансляции сетевого адреса, при которой внешний адрес отправителя подставляется динамически, в зависимости от назначенного провайдером адреса

**NAT Masquerading** -  используются для выхода в интернет группы компьютеров с внутренними адресами через один внешний адрес. IP-адрес, в который происходит подмена, должен быть прописан на интерфейсе

**Destination NAT / PAT (DNAT)** - технология трансляции сетевого адреса в зависимости от TCP/UDP-порта получателя

**Destination NAT / PAT** -  используются для публикации сервиса (port), находящегося внутри сети, для внешних пользователей

NAT в Linux реализуется с помощью **iptables**

# VPN

**Virtual Private Network** - Виртуальная частная сеть - механизм, позволяющий настроить подключение устройств через сети общего доступа, так, как если бы они находились в одной (частной) сети

**Зачем нужен VPN**
- Полный контроль сети (private) - Задать жесткое соответствие между IP адресом и пользователем/устройством
- Шифрование  - Передавать данные в зашифрованном виде, повышая безопасность передаваемых данных
- Единая адресация, разграничение доступа - Разграничить доступ квнутренним ресурсам основываясь только на L3 адресах
- Контроль действий сотрудников - На основе адресов можно вестистатистику запросов с привязкой к пользователю
- Сокрытие / маскировка реального IP-адреса - Анонимность запросов, обезличивание как защита от неправомерных действий через социальную инженерию
- Доступ к заблокированным ресурсам - Обеспечить доступ к недоступнымпо региональному признаку ресурсу

**Виды VPN**
- Точка - точка (Point-to-Point)
- Точка - Сеть (Remote Access)
- Сеть - сеть (Site-to-Site)
- VPN-сервис в браузере

**VPN Point-to-Point** (p2p, точка-точка) - используются для соединения между собой двух устройств

**VPN-туннель** - зашифрованное подключение между двумя точками, VPN клиентом и VPN сервером, через общедоступные сети. При взаимодействии все реальные промежуточные узлы будут скрыты

**VPN Remote access** - пример - Подключение с помощью веб-браузера к внутреннему ресурсу компании, в нашем случае – веб серверу. Так часто реализуется подключение к Outlook Web Access (OWA) client

Clientless SSL VPN веб-портал позволяет предоставить доступ к внутренним веб-ресурсам, терминальным и SSH-серверам компании для удаленных или мобильных пользователей, используя защищенное HTTPS-соединение веб-браузера

Требования для Clientless SSL VPN
- Специальное оборудование, поддерживающее данный режим
- Настройка отдельного сервера

**Cisco Anyconnect** - Популярный корпоративный VPN клиент - VPN Подключение с помощью специального ПО (VPN клиента) к VPN серверу компании с использованием шифрования и авторизации

**VPN Site-to-Site** - используются для объединения удалённых офисов через публичную сеть интернет. Для конечных пользователей VPN выглядит прозрачным, при трассировке никаких «белых» IP- адресов никто не увидит

**VPN протоколы**
- PPTP - Point-to-Point Tunneling Protocol
- SSTP - Secure Socket Tunneling Protocol
- WireGuard 
- OpenVPN
- L2TP / IPSec - Layer 2 Tunneling Protocol / IP Security

**PPTP** -  туннельный протокол типа точка-точка, позволяющий компьютеру устанавливать защищённое соединение с сервером за счёт создания специального туннеля в стандартной, незащищённой сети
- Работает на L4 уровне, поверх TCP
- Предоставляет сервисы L2 уровня

**PPTP использует два соединения**
- Одно соединение для управления - Работает с использованием TCP, в котором порт сервера 1723
- Второе соединение для инкапсуляции данных - Работает с помощью протокола GRE, который является транспортным протоколом (то есть заменой TCP/UDP)

Особенности PPTP
- Несмотря на относительно высокую скорость, PPTP не слишком надежен: после обрыва соединения он не восстанавливается так же быстро, как, например, OpenVPN
- В настоящее время PPTP по существу устарел и Microsoft советует пользоваться другими VPN решениями, так как обладает серьёзными уязвимостями

**L2TP** - протокол туннелирования второго уровня, используется для поддержки виртуальных частных сетей
- Работает на L4 уровне, поверх UDP
- Предоставляет сервисы L2 уровня

**Протокол L2TP** при передачи данных по туннелю L2TP кадр L2TP помещается в дейтаграмму UDP и пересылается конечной точке

Какие особенности L2TP?
- L2TP / IPsec считается безопасным и не имеет серьезных выявленных проблем (гораздо безопаснее, чем PPTP)
- L2TP / IPsec может использовать шифрование 3DES или AES, хотя, учитывая, что 3DES в настоящее время считается слабым шифром, он используется редко
- У протокола L2TP иногда возникают проблемы из-за использования по умолчанию UDP-порта 500, который иногда блокируется брандмауэрами

**SSTP** - безопасный протокол туннелирования сокетов, проприетарный продукт от Microsoft
- Работает на Прикладном уровне L7
- Предоставляет сервисы L2 уровня

**Протокол SSTP** - отправляет трафик по SSL через TCP-порт 443

Особенности SSTP
- Как и PPTP не очень широко используется в VPN, но, в отличие от PPTP, у него не диагностированы серьезные проблемы с безопасностью
- SSTP удобен для использования в ограниченных сетевых ситуациях, например, если вам нужен VPN для Китая
- Несмотря на то, что SSTP также доступен и на Linux, RouterOS и SEIL, по большей части он все равно используется Windows- системами

**WireGuard** - коммуникационный протокол и бесплатное программное обеспечение с открытым исходным кодом, который реализует зашифрованные виртуальные частные сети
- Работает поверх L4 (UDP)
- Предоставляет сервисы L2 уровня

**WireGuard** - один из новейших VPN протоколов, распространяется по GNU GPL

Особенности WireGuard
- WireGuard не предоставляет выбор алгоритма или уровня шифрования. Благодаря этому:
- - Код сократился до 4 тысяч строк, что позволяет легче осуществлять аудит безопасности
- - Настройка осуществляется гораздо проще
- - Работает гораздо быстрее с приемлемым уровнем безопасности
- В Linux системах реализован в виде модуля ядра, что дополнительно увеличивает производительность
- Протокол может работать на любом из портов UDP, существуют клиенты под все основные платформы: Windows, Mac OS, Linux, Apple OS, Android

**OpenVPN** - универсальный протокол VPN с открытым исходным кодом, разработанный компанией OpenVPN Technologies
- Работает на L4 уровне, поверх TCP и UDP
- Предоставляет сервисы на уровне L2

**OpenVPN** самый популярный протокол VPN. Будучи открытым стандартом, он прошел не одну независимую экспертизу безопасности. OpenVPN использует библиотеку OpenSSL для шифрования и аутентификации, большинство VPN-сервисов создают свои приложения для работы с OpenVPN, которые можно использовать в разных операционных системах и устройствах

Особенности OpenVPN
- Для работы OpenVPN нужно специальное клиентское программное обеспечение
- OpenVPN является альтернативой IPsec тогда, когда провайдерблокирует некоторые протоколы VPN
- Протокол можетработать на любом из портов TCP и UDP и может использоваться на всех основных платформах через сторонние клиенты: Windows, Mac OS, Linux, Apple iOS, Android

**IPSec** -  стек сетевых протоколов для защищенной передачи данных через IP-сети

IPsec обеспечивает
- Аутентификацию
- Шифрование
- Проверку целостности передаваемых данных

Режимы IPsec
- Транспортный режим - Работает поверх протокола IP и шифрует содержимое IP-пакета (payload) - Адреса отправителя и получателя не шифруются, поэтому можно проанализировать адреса и объем переданной информации
- Туннельный режим Создает новый IP-пакет, полностью шифруя исходный - Использование туннельного режима сильно затрудняет анализ перехваченного трафика

- Транспортный режим - Чаще всего используется для соединения между хостами
- Туннельный режим - Чаще всего используется для передачи данных через Интернет

**Туннелирование (tunneling)** -  метод, используемый для передачи полезной нагрузки (кадра или пакета) одного протокола с использованием межсетевой инфраструктуры другого протокола

**Tunnel** - Вкладываются данные этого же или более нижних сетевых уровней

**Security Association** - базовое понятие IPsec. Включает в себя информацию о криптографических протоколах и алгоритмах, лючах шифрования, определяет какие данные будут проходить через туннель

Алгоритм работы IPsec
- Установка и поддержка VPN туннеля происходит в два этапа
- - В фазе один, узлы договариваются о:
- - Методе идентификации 
- - Алгоритме шифрования
- - Хэш алгоритме 
- - Группе Diffie Hellman
- - Также происходит взаимная идентификация
- Если шаги в первой фазе завершились успешно, то создаётся SA первой Фазы (Phase 1 SA или IKE SA) и процесс переходит к фазе два
- - В этой фазе генерируются ключи и узлы договариваются об используемой политике
- Если вторая фазы выполняется успешно, то создается Phase 2 SA или IPSec SA. На этом установка туннеля считается завершенной

# dhcp-dns-https
# DHCP
**Dynamic Host Configuration Protocol** - Протокол динамической конфигурации узла - сетевой протокол прикладного уровня модели TCP/IP
позволяющий сетевым устройствам автоматически получать IP-адрес и другие параметры, необходимые для работы в сети. Работает на 67/68 портах поверх UDP.

**DHCP** является расширением и дополнением протокола **BOOTP**

**BOOTSTRAP PROTOCOL** - Протокол начальной загрузки - сетевой протокол, используемый для автоматического получения клиентом IP-адреса (обычно во время загрузки компьютера)

**Термины DHCP:**
- Scope (область) - диапазон IP-адресов, из которого сервер будет предлагать адреса клиенту в аренду
- Reservation (резервирование) - закрепление IP адреса за конкретным устройством
- Lease (аренда) - период, в течение которого клиент может использовать IP-адрес
- Exclusion range (исключаемый диапазон) - диапазон IP-адресов, которые не могут быть назначены клиенту
- Address pool (пул адресов) -  свободные IP-адреса, готовые к выдачи клиентам

**Формат кадра DHCP:**
-  Opcode (op) – тип DHCP-сообщения
- - 0×01 запрос от клиента к серверу BOOTREQUEST
- - 0×02 ответ DHCP-сервера или BOOTREPLY
-  Hardware Type (htype) – тип адреса на канальном уровне. 0x01 для протокола Ethernet и MAC-адресов.
- Hardware Length (hlen) – длина аппаратного адреса в байтах. Для Ethernet значение 0×06
- Hops – количество промежуточных маршрутизаторов, которые находятся на пути между клиентом и сервером. DHCP-клиенты всегда ставят значение 0×00
- Transaction ID (xid) – случайное значение для идентификации диалога
- Seconds Elapsed (secs) – время в секундах с момента начала процесса получения IP-адреса
- Flags – поле для флагов или специальных параметров DHCP
- Client IP Address (ciaddr) – IP-адрес клиента. Клиент заполняет его в случае, если клиент хочет продлить аренду IP-адреса
- Your ID Address (yiaddr) – IP-адрес, который DHCP-сервер предлагает клиенту.
- Server IP Address (siaddr) – IP-адрес сервера
- Gateway IP Address (address) – IP-адрес промежуточного DHCP Relay Agent.
- Client Hardware Address (chaddr) – Если используется протокол Ethernet, то в это поле записывается MAC-адрес клиента
- Server Host Name (sname) – доменное имя сервера, поле не является обязательным.
- Boot File (file) – указатель файла для загрузки бездисковым станциям, не является обязательным.
- Options - опции для динамической конфигурации хоста

**Виды DHCP сообщений:**
- DHCPDISCOVER - обнаружение DHCP (Широковещательный запрос для обнаружения DHCP-сервера)
- DHCPOFFER - предложение DHCP (Сервер определяет конфигурацию в соответствие с серверными настройками, резервирует IP адрес и отправляет конфигурацию)
- DHCPREQUEST - запрос DHCP (Клиент выбирает одну из конфигураций, предложенных серверами и отправляет запрос на эту конфигурацию широковещательно, чтобы другие сервера знали, что их предложение отклонено)
- DHCPACK - подтверждение DHCP (Обмен сообщениями закончен, и клиент должен применить полученные настройки)
- DHCPDECLINE – отправляется клиентом, если он обнаруживает что адрес, предложенный сервером уже используется в сети
- DHCPNACK – отправляется сервером; после такого сообщения клиент должен повторить процедуру инициализации
- DHCPRELEASE – отправляется клиентом, если он по какой-то причине хочет прекратить аренду
- DHCPINFORM – отправляется клиентом, в случае если ему нужны только опции и не нужен IP адрес
- RENEWING – клиент отправляет запрос на продление аренды
- Сервер отвечает DHCPACK с подтверждением продолжения аренды и обновленными параметрами
- В случае отказа от продолжения аренды сервер отправляет DHCPNACK и клиент начинает инициализацию заново
- REBINDING - при неполучении ответа, клиент пытается продлить аренду через широковещательные запросы Если и это не выходит, клиент заново ищет DHCP-сервер

DHCP сервер может сообщать клиенту дополнительные параметры для работы в сети, количество опций зависит от реализации сервера
- domain-name-servers - настраивает на клиенте к какому серверу dns-имен обращаться
- next-server - сервер, для загрузки ПО на клиента
- smtp-server - список доступных клиенту почтовых серверов

Безопасность DHCP:
- DHCP Starvation (истощение ресурсов) - Адреса могут быть исчерпаны злонамеренно при достаточном количестве запросов - Легитимные клиенты не могут получить настройки и подключиться к сети
- DHCP Snooping (отслеживание) - Злоумышленник может установить свой DHCP сервер - Порты помечаются как доверенные и нет. Если на недоверенном порту появиться DHCP сервер – коммутатор заблокирует этот порт - точнее коммутатор не пропустить DHCP ответ к сторону клиента.
- Rogue DHCP Server (мошеннический DHCP-сервер) -  DHCP сервер может быть подменен - Клиента могут заставить работать через сетевые устройства злоумышленника, весь трафик может быть перехвачен

**Preboot eXecution Environment** - Cреда предварительного исполнения - технология, которая позволяет компьютеру загружаться и работать используя сетевую карту

Для запуска компьютера достаточно иметь:
- Клиент, поддерживающий PXE - Большинство современных компьютеров поддерживает PXE
- DHCP-сервер - Экземпляр сервера, который поддерживает необходимые опции и сконфигурированный для отправки ответов
- TFTP-сервер - Сервер, на котором размещены файлы загрузки

Варианты использования PXE:
- Установка - Можно использовать для установки операционной системы на компьютеры через сеть
- Загрузка - Для работы с операционной системой или с программным обеспечением через сеть

# DNS

**DNS (Domain Name System, система доменных имён)** – это распределённая иерархическая система доменных имён, которая связывает буквенные названия (имена) доменов с IP- адресами компьютеров, соответствующих этим доменам.

**Файл hosts** выполняет то же функцию что и DNS-сервер, но делает это локально. По умолчанию это первый источник, где Linux будет пытаться разрешить имя в IP адрес. Если в вашей сети нет DNS сервера или он неисправен – временным решением может служить внесение записей в файл /etc/hosts.

**FQDN (Fully Qualifed Domain Name, полностью определённое имя домена)** – это имя домена, однозначно определяющее доменное имя и включающее в себя имена всех родительских доменов иерархии DNS, в том числе и корневого. Ближайший аналог абсолютный путь в файловой системе.

**Архитектура DNS** - Архитектурно система DNS строится на иерархической распределенной модели.

**Корневые сервера** -  В верхней части иерархической системы доменных имен находится 13 корневых серверов. До 30% обращений приводит к обращению к корневому серверу. У корневых серверов множество реплик. Имена корневых серверов выглядят {a-m}.root-servers.net. В РФ также есть несколько реплик корневых DNS серверов.

Типы DNS-серверов:
- корневой – это DNS-сервер, который хранит в себе адреса всех TLD-серверов (TLD – top-level domain, домен верхнего уровня);
- TLD-серверы – эти серверы связаны с доменами верхнего уровня (TLD), обычно они идут после корневых DNS-серверов;
- авторитативный DNS-сервер – это серверы, которые ответственны за зону. Они хранят фактические записи типа A, NS, CNAME, TXT, и т. п. Авторитативные DNS-серверы по возможности возвращают IP-адреса хостов. Если сервер этого сделать не может — он выдаёт ошибку, и на этом поиск IP-адреса по серверам заканчивается.

Авторитативные DNS-сервера:
- первичный (primary master) – вносить изменения в описание зоны может только администратор данного сервера. Все остальные серверы только копируют информацию с master- сервера.
- вторичный (secondary master) – также является ответственным (authoritative) за зону. Его основное назначение заключается в том, чтобы подстраховать работу основного сервера доменных имен (master server), ответственного за зону, на случай его выхода из строя, а также для того, чтобы разгрузить основной сервер, приняв часть запросов на себя.

**Делегирование домена** — это передача контроля над частью доменной зоны другой ответственной стороне. Делегирование осуществляется с помощью записи NS, в которой указывается адрес DNS-сервера , отвечающего за поддержание зоны и определяющего её содержимое

Виды запросов:
- рекурсивный – это первый запрос, который выполняется в процессе DNS-поиска и выполняется от пользователя к резолверу;
- нерекурсивные – резолвер сразу возвращает ответ без каких- либо дополнительных запросов на другие сервера имён; это случается, если в DNS-сервере был закэширован необходимый IP-адрес либо если запрос поступает напрямую на авторитативные сервер;
- итеративный – итеративный запрос выполняется, когда резолвер не может вернуть ответ, потому что он не закэширован и он выполняет запрос на корневой DNS-сервер.

**Типы ресурсных записей:**
- А Address record (запись адреса) указывает на соответствие между доменным именем и IP-адресом (IPv4).
- AAAA Аналогична записи A, но указывает соответствие доменного имени для IPv6.
- CNAME Canonical name – запись, которая позволяет присваивать домену каноническое имя для псевдонима (одноуровневая переадресация).
- DKIM DomainKeys Identified Mail – технология e-mail-аутентификации, которая позволяет подтвердить подлинность отправителя. DKIM добавляет в сообщение цифровую подпись, удостоверяющую, что письмо действительно поступило с ящика на указанном домене. Наличие DKIM повышает доверие серверов-получателей к письму и тем самым снижает его шансы оказаться в папке «Спам» или вовсе быть отклоненным принимающим сервером.
- MX Запись, указывающая на адрес почтового шлюза для домена. Состоит из двух частей: приоритета (чем число больше, тем ниже приоритет) и адреса узла.
- NS Указывает на DNS-сервер, обслуживающий данный домен, т.е. указывает серверы, на которые домен делегирован. Данный тип записи критически важен для функционирования самой системы доменных имён.
- PTR Pointer – запись, которая указывает на соответствие адреса имени — обратное соответствие для A и AAAA.
- SRV Server selection – этот тип записи указывает на серверы, обеспечивающие работу тех или иных служб в данном домене (например, Jabber, Active Directory).
- SOA Start of Authority (начальная запись зоны) – запись описывает основные/начальные настройки зоны, определяет зону ответственности данного сервера. Для каждой зоны должна существовать только одна запись SOA.
- TXT Запись содержит вспомогательную информацию о домене (запись произвольных данных). Записи TXT используются для различных целей: подтверждения права собственности на домен, обеспечения безопасности электронной почты, а также подтверждения SSL-сертификата. Можно прописывать неограниченное количество TXT-записей

Реализации DNS-сервера:
- BIND (Berkeley Internet Name Domain) – наиболее распространенная реализация DNS-сервера (10 из 13 корневых серверов работают на BIND);
- NSD (NLnet Labs Name Server Daemon) – быстрый DNS сервер, выступающий только в роли мастера (не реализует рекурсивные запросы и кэширование);
- PowerDNS – open source продукт, поставляется в 3 версиях, позиционируется как быстрый;
- Microsoft DNS Server – роль на Microsoft Server, прекрасно интегрируется в экосистему добавляя много функционала.

**BIND (Berkeley Internet Name Domain)** – разработанная в 1980-х годах в Университете Berkley реализация DNS-сервера. Является самым популярной в интернете и входит в поставку почти всех дистрибутивов LInux. BIND обладает огромным количеством настроек и интеграций.

Настройка DNS клиента
- vim /etc/hosts - прямое указание адрес - имя
- vim /etc/resolv.conf - dns сервера которые опрашиваем - можно добавить search ru - зона по умолчанию, если не нашли netology, то ищем netology.ru
- vim /etc/nsswitch.conf - строчка hosts - порядок опроса - файл, сервер - можно менять
- Автоматическая через опции DHCP - параметр с dns сервером
- resolvconf
- systemctl status systemd-resolved
- systemd-resolve --flush-caches
- systemctl status dnsmasq

Утилиты для диагностики:
- nslookup – утилита для отправки запросов DNS серверам;
- dig (Domain information groper) – утилита для отправки запросов DNS серверам; входит в пакет bind-utils.
- whois – утилита, выводящая информацию о домене:
- - ns сервера;
- - регистратора;
- - дату регистрации;
- - дату истечения срока регистрации;
- - информацию о владельце.
- systemd-resolve – демон для настроки / диагностики настроек DNS на стороне клиента.
- dnstop – программа позволяет отслеживать трафик от/к DNS серверу.

Атаки на DNS:
- DNS-флуд – на DNS-сервер отправляется множество запросов, которые потребляют ресурсы сервера / сети, тем самым не давая возможности легитимным клиентам получить ответы на их запросы;
- Атака посредством отраженных DNS-запросов – на DNS сервер отправляется множество запросов, при этом адрес отправителя меняется на адрес сервера-жертвы. Т.к. ответ больше запроса, то канал до сервера жертвы забивается паразитным трафиком, ем самым не давая возможности легитимным клиентам получить ответы на их запросы.
- Атака при помощи рекурсивных DNS-запросов – отправляется множество рекурсивных запросов к DNS серверу. Т.к. такие запросы потребляют много ресурсов - производительность сервера падает;
- Garbage DNS – суть данной атаки в переполнении канала до сервера путем отправки пакетов большого размера(1500 байт и больше) на сервер-жертву;
- Подмена DNS сервера - перехватив пакеты или иным способом заставить поверить клиента что атакующая машина и есть легитимный DNS сервер;

# HTTP / HTTPS

**HTTP (HyperText Transfer Protocol, протокол передачи гипертекста)** – протокол изначально созданный для передачи документов HTML, но использующийся в данный момент для передачи любых данных. В основе протокола лежит технология клиент-сервер.

**Структура протокола:**
- Стартовая строка – содержит параметры типа сообщения, имеет различную структуру для клиента и сервера. Имеет вид:
- Для клиента: - Метод URI HTTP/Версия - Пример: GET / HTTP/1.1
- Для сервера: - HTTP/Версия КодСостояния Пояснение - Пример: HTTP/1.1 200 OK
- Заголовки – используются для передачи любых дополнительных параметров. ➡ Например, о типе данных в сообщении или о наличии. Начиная с версии 1.1 заголовок Host является обязательным.
- Тело – непосредственно сами данные.

**Методы HTTP запроса:**
- GET - Используется для получения данных (заголовок, тело) с сервера.
- POST - Применяется при передаче данных от клиента на сервер.
- PUT - Используется для загрузки данных на указанный ресурс.
- OPTIONS - Получение информации о сервере. Обычно используется для получения возможностей сервера.
- HEAD - Аналогично GET но без получения данных (тело) с сервера. Ранее использовался для получения метаданных, но без загрузки самих данных. (узнать есть ли файл, его размер)
- PATCH - Аналогичен PUT, но используется для правки только части данных. (PUT если не указать все данные - перезапишет и удалит то чего нет, PATCH - оставт что есть и перепишет новое)
- DELETE - Удаляет ресурс с сервера.

**Коды состояния HTTP:**
- 1ХХ Информационные ответы.
- 2ХХ Успех. Сообщает об успехе того или иного запроса.
- 3ХХ Перенаправление. Сообщает о том что ресурс доступен по другому адресу.
- 4ХХ Сообщает о наличии ошибки со стороны клиента.
- 5ХХ Сообщает о наличии ошибки на стороне сервера.

В header передается Content-type - Позволяет клиенту понять содержимое ответа и по разному обрабатывать различный контент.
- text/plain – является типом по умолчанию для текстовых файлов;
- application/octet-stream – является типом по умолчанию для всех остальных случаев.
- text/html – HTML содержимое;
- image/jpeg – JPEG изображения;
- audio/mpeg – mp3 аудио.

ss -t  / netstat -t - проверка tcp портов 
cat /etc/protocols - какие поротоклы бывают

**HTTPS (HyperText Transfer Protocol Secure)** — расширение протокола HTTP, поддерживающее шифрование. Данные, передаваемые по протоколу HTTP, «упаковываются» в криптографический протокол SSL или TLS. В отличие от HTTP, для HTTPS по умолчанию используется TCP-порт 443.

**Server Name Indication (SNI)** — расширение компьютерного протокола TLS, которое позволяет клиентам сообщать имя хоста, с которым он желает соединиться во время процесса «рукопожатия». Это позволяет серверу иметь несколько сертификатов на одном IP-адресе и TCP- порту и предоставлять нужный в момент рукопожатия.

Первый ответ, который клиент получает на запрос GET, часто содержит не всю страницу, а ссылки на дополнительные ресурсы, необходимые для запрашиваемой страницы. Только после загрузки страницы клиент обнаруживает, что для полной визуализации от сервера требуются эти дополнительные ресурсы. Потому клиенту приходится делать дополнительные запросы для извлечения этих ресурсов. В HTTP/1.0 клиент должен был разрывать и снова создавать TCP-соединение для каждого нового запроса, а это довольно затратно с точки зрения времени и ресурсов.

**HTTP/1.1** устраняет эту проблему через постоянные соединения и конвейерную обработку (pipelining).

**HTTP2:**
- возможность выбирать протокол, например, HTTP/1.1, HTTP/2 или другой;
- высокая совместимость с HTTP/1.1 — методы, коды статусов, поля хедеров;
- улучшение скорости загрузки благодаря сжатию хедеров запросов, бинарному протоколу, отправке данных по инициативе сервера, блокировке пакетов и запросу многократной передачи данных.

**HTTP2 Мультиплексирование** - Использование одного TCP соединения для загрузки нескольких ресурсов с одного серверa. Включить http2 можно только на сервере на котором настроен SSL

**RPC** - это удаленный вызов процедур. Стек технологий для выполнения каких либо операций на удаленном сервере. Обычно состоит из сетевого протокола и языка описания структур.

# osi7-ipv6-troubleshooting
# Высокоуровневые сетевые протоколы

**Прикладной уровень** – последний уровень модели OSI, обеспечивает взаимодействие сети и пользователя.
- Примеры протоколов: HTTP; DNS; IMAP; SSH; FTP.

**FTP (File transfer protocol)** – протокол передачи файлов. Реализует обмен файлов между клиентом и сервером. Есть поддержка активного и пассивного режима.

Состоит из 2-х процессов:
- управляющий процесс;
- процесс передачи данных.

**Основы шифрования**

Шифрование с открытым ключом
- У каждого участника есть 2 ключа: публичный и приватный.
- Публичный ключ может только шифровать сообщения.
- Приватный ключ может только расшифровывать сообщение, и только те сообщения что были зашифрованы связанным с ним приватным ключом.
- Асинхронное шифрование является медленным и ресурсозатратным, поэтому используется только для гарантии безопасного обмена общим сеансовым ключом.
- Сеансовый ключ может зашифровывать и расшифровывать.
- Создается на время в момент рукопожатия.

SSL рукопожатие
- (Клиент) Запрос на поделючение
- (Сервер) Отправка публичного ключа
- (Клиент)Шифрование с помощью публичного ключа сгенерированного публичного ключа
- (Сервер) Расшифровка сгенерированного ключа и его использование для обмена данными

**Генерирование ключей SSH**
- устанавливаем OpenSSH сервер (Ubuntu): sudo apt-get install openssh-server
- генерируем ключ: ssh-keygen -t rsa
- получаем файлы:
  - /home/user/.ssh/id_rsa
  - /home/user/.ssh/id_rsa.pub
- записываем публичный ключ: cat /home/user/.ssh/id_rsa.pub >> /home/user/.ssh/authorized_keys
- пробуем подключиться с использованием ключа: ssh -i /home/user/.ssh/id_rsa localhost

**SSL Сертификаты**

Цепочка доверия
- Корневой сертификат – сертификат, с правом подписи. Генерируется изначально.
- Промежуточный сертификат – обычно сертификат с правом подписи. подписанный корневым, выдается компаниям посредникам между ЦС и конечным пользователям.
- Конечный сертификат – подтверждает владение неким цифровым активом (например, доменом).

Реализация получения конечного сертификата:
- Публичный ключ (PUB2) отправляется в ЦС.
- ЦС создает сертификат в котором есть зашифрованный приватным ключом PRIV1 ключ PUB2.
- Любой, кто хочет проверить подлинность сертификата, может взять ключ PUB1, расшифровать сертификат и получить PUB2.

ACME - Описывает методы тестирования домена и приватных / публичных ключей для запрашиваемого сертификата. Позволяет автоматизировать процесс получения сертификата.

# Траблшутинг

**Troubleshooting (устранение неполадок, работа над проблемой)** — форма решения проблем, часто применяемая к ремонту неработающих устройств или процессов. Представляет собой систематический, опосредованный определённой логикой поиск источника проблемы с целью её решения. Траблшутинг как поиск и устранение неисправностей необходим для поддержания и развития сложных систем, где проблема может иметь множество различных причин.

**Основные проблемы в сетях**
- физические (L1) – кабель отключен или повреждён;
- connectivity (L1, L2) – порт на оборудовании может быть не настроен, заблокирован или отключен;
- некорректная настройка (L2, L3, L4) – некорректный IP-адрес, маршрут, шлюз, блокировка на стороне firewall’а, и т.д.;
- некорректная работа ПО (L5-L7) – несоответствие версий ПО, выключенное ПО, неправильно настроенный порт, и т.д.;
- загрузка канала – попытка передать через канал большее количество информации, чем возможно;
- проблема на стороне провайдера

Л – логика. Л – локализация проблемы.
- Если один клиент жалуется на отсутствие доступа к разным сервисам – скорее всего проблема только у него (компьютер, IP-адрес, сеть, ПО).
- Если много клиентов жалуется на отсутствие доступа к одному сервису – скорее всего проблема в сервисе.
- Если много клиентов жалуется на отсутствие доступа к разным сервисам – скорее всего или глобальные проблемы в локальной сети, или проблемы у провайдера.

**Физические проблемы** - Здесь всё достаточно просто – что бы ни случилось, для работы всегоостального должна быть связность на физическом уровне модели OSI (Layer 1).
- Если не работает физическое подключение – не будет работатьничего!

Вопросы, на которые нужно иметь положительный ответ:
- Есть ли электричество на оборудовании? Включена ли VM?
- Подключен ли кабель?
- Если подключен – уверены ли вы, что он целый?

Проблемы с connectivity (L1, L2)
Здесь всё ещё достаточно просто, хотя немного сложнее – всё может быть подключено, но всё равно не работать.

Вопросы, на которые нужно иметь положительный ответ:
- Если кабель подключен и в порядке – горит ли лампочка (есть ли «линк»)?
- Не заблокирован ли порт в настройках коммутатора / сервера?
- Не заблокирован ли MAC-адрес на коммутаторе?

Команды поиска проблем на L1, L2
- ip link - eth1 – NO-CARRIER означает, что сетевой разъем не обнаруживает сигнал на линии. UP / state DOWN – интерфейс работает / не подключён (LOWER_UP отсутствует)

**Некорректная настройка (L2, L3, L4)**
Вопросы, на которые нужно иметь положительный ответ:
- Есть ли связь на L2? Вижу ли я компьютеры внутри локальной сети
- Есть ли связь на L3?
- Много что работает, не работает связь именно с этим IP-адресом. Тестируем с помощью arp, ping, trace.
- Есть ли связь на L4? Хост доступен, однако не работает конкретный сервис. Тестируем с помощью telnet со стороны клиента, ss / netstat со стороны сервера, просматриваем правила firewall’а

Команды поиска проблем на L2 (arp, arping)
- Просмотр arp (связь L2 и L3)
  - ip neigh show dev eth1
  - arp -i eth1
- Опрос устройства на L2
  - sudo arping -c 1 10.0.2.3
- Просмотр трафика L2
  - sudo tcpdump -i any arp -nn -A -e  (С опцией -e программа tcpdump будет печатать заголовки канального уровня в каждой выведенной строке. С опцией -A команда tcpdump будет отображать на экране содержимое пакетов в формате ASCII. Опция -nn отображает порты и IP-адреса цифрами вместо имён (localhost, ssh, http, и т.д.))
- ip -4 address
- ip route list
- Опрос хоста на L3
  - ping -c 1 netology.ru
- Проверка маршрута до хоста L3
  - traceroute -n ya.ru
  - ip route list
  - cat /etc/resolv.conf 
- Поиск проблемы на L4
  - telnet ya.ru 80
  - curl -v http://ya.ru:80

Если нет связи по нужному нам порту, при том что хост доступен, пытаемся подключиться ещё куда-то по тому же порту (TCP / UDP), чтобы понять, не блокируется ли подключение нашим сетевым администратором на пограничном роутере.

Также просматриваем правила нашего firewall’а
- sudo iptables -L -v

В зависимости от того что покажет tcpdump на разных хостах, мы сможем делать дальнейшие выводы о локализации проблемы:
```
root@netology1:~# tcpdump -nn -i eth1
10:34:38.393610 IP 172.28.128.10.50700 > 172.28.128.60.80: Flags [S]...
10:34:39.423744 IP 172.28.128.10.50700 > 172.28.128.60.80: Flags [S]...
root@netology2:~# tcpdump -nn -i eth1 # (вариант 1)
10:34:37.621593 IP 172.28.128.10.50700 > 172.28.128.60.80: Flags [S]...
10:34:38.652240 IP 172.28.128.10.50700 > 172.28.128.60.80: Flags [S]...
root@netology2:~# tcpdump -nn -i eth1 # (вариант 2)
```
- Вариант 1 говорит о том, что TCP сегменты на хост netology2 приходят, но не генерируются ответные.
- Вариант 2 говорит о том, что сегменты до хоста netology2 не доходят.

**Некорректная работа ПО (L5-L7)**

Здесь многое аналогично L4, т.к. если диагностировать проблему выше 3-го уровня, то со стороны клиента это будет выглядеть как «связь в принципе есть, однако ответ на мой запрос по порту 80 не приходит». И понять, в чём именно причина, не имея доступа к серверной части, иногда сложно.

Вопросы, на которые нужно иметь положительный ответ:
- Есть ли связь на L4 по тем же портам с другими хостами?
- Корректно ли работает ПО со стороны клиента?
- Корректно ли работает ПО со стороны сервера?

Есть ли связь на L4/L7 с другими хостами?
- Если связь у клиента по тем же популярным портам (80, 443, 22, 23, и т. д.) с другими хостами есть, это означает, что с клиентской стороны скорее всего всё в порядке.
- При этом без доступа к серверу понять причину будет невозможно, но попробовать можно.
- Если речь идёт о подключении к высокодоступным сервисам (Yandex, Google, и т.д.) – проблема чаще на стороне пользователя или провайдера. Можно попробовать изменить внешний IP-адрес и проверить ещё раз.

Если есть доступ к серверу
- запущена ли служба (ps aux);
  - ps – утилита для сбора информации о запущенных процессах
- слушает ли она нужный порт (ss, netstat);
  - socket statistics – наиболее актуальная утилита для сбора информации о сокетах, в частности сетевых сокетах. Аналог netstat.
  - ss -4 state listening state unconnected -n | column -t
  - ss state connected sport != :ssh -t | column -t - установленные TCP соединения не на порт SSH
  - lsof – мощная утилита, в том числе для получения информации по сети. Среди прочего он поможет вам узнать, какому процессу принадлежит прослушиваемый порт:
  - sudo lsof -ni :22
- какие ошибки есть в логах (/var/log/*.log, файл зависит от сервиса
  - remote syslog - rsyslog - можно мониторить и собирать логи отдельно
  - kibana - используется для мониторинга и анализа ИТ-инфраструктуры в составе Elastic Stack (ранее ELK Stack), в который помимо нее входят Elasticsearch и Logstash. Logstash отвечает за логирование и поставляет входящий поток данных в Elasticsearch для хранения, классификации и поиска. Kibana, в свою очередь, получает доступ к данным Elasticsearch для их визуализации в различных визуальных форматах, например – в виде информационных панелей (dashboards) с различными видами диаграмм
 
**Загрузка канала** - Если пинг от клиента к серверу стабильно высокий, плюс «тормозит» не только этот сервис – можем попробовать сделать вывод о том, что канал загружен. Если же медленно работает только один сервис – проблема на стороне сервиса.
- iftop
- bmon
- sampler
- gping

Проблема не на нашей стороне
- Если trace показывает потери или сильное увеличение задержек на каком-то узле вне нашей зоны ответственности – мы ничего сделать не можем.
- Если не можем подключиться только к конкретному серверу, к остальным по тем же портам подключаемся.
- Рекомендации – попробовать подключение с другого оператора (с 4g роутера, резервного канала, и т.д.) + пообщаться с сетевым администратором и / или коллегами, может быть недавно вносили какие-то изменения в конфигурационные файлы
- mtr 8.8.8.8
- tracepath -n 8.8.8.8
- iperf3

# IPv6
Зачем нужна замена IPv4?
- Недостаточное количество IP-адресов;
- IPv4 ребует множество дополнительных технологий (VLSM,CIDR,NAT, DHCP) для работы

Преимущества IPv6 перед IPv4
- IPv6 обеспечивает более эффективную маршрутизацию, поскольку значительно уменьшает размер таблицы маршрутизации;
- у нового протокола формат заголовка проще, чем у IPv4;
- обработка пакетов более эффективна, поскольку заголовки пакетов оптимизированы;
- в протокол встроена технология Quality of Service (QoS), которая определяет чувствительные к задержке пакеты;
- более упрощенные задачи маршрутизаторов по сравнению с IPv4;
- IPv6 обеспечивает большую полезную нагрузку, чем IPv4

Размер адреса IPv6 – 128 бит:
- адрес записывается в шестнадцатеричном формате;
- 8 групп по 4 разряда, разделенные двоеточиями.

**Маска адреса IPv6**
Как и в IPv4 адрес делится на две части:
- Network ID – общий для всех узлов в канальной среде;
- Interface ID – идентификатор узла в канале.
- Стандартная (ожидаемая) маска для хостов – /64, формат записи префиксный.

**SLAAC (Stateless Address Autoconfiguration, автонастройка адреса без сохранения состояния)** – это механизм автоконфигурации узла, который используется для автоматического получения IP адреса и сетевого префикса узлом, без использования DHCPv6-сервера, или совместно с ним. SLAAC основан на новых возможностях ICMPv6
- Только SLAAC - Маршрутизатор выдаёт подсеть, префикс и адрес шлюза. Другую информацию устройства не получают.
- SLAAC и DHCPv6 - Маршрутизатор выдаёт подсеть, префикс и адрес шлюза, а отдельный DHCPv6-сервер выдаёт дополнительную информацию: опции, маршруты, адреса DNS-серверов и т.д.
- Только DHCPv6 - Устройство не использует RA от маршрутизатора, а обращается к DHCPv6- серверу, который предоставляет всю необходимую информацию, включая адрес, шлюз, префикс, DNS-сервера и т.д

Механизм EUI-64 (Extended Unique Identifier) позволяет хосту в IPv6 самостоятельно генерировать себе идентификатор интерфейса – то есть вторую половину IPv6 адреса.

Порядок работы EUI-64:
- MAC адрес делится на две части по 24 бита каждая;
- между этими частями вставляются шестнадцатеричные цифры FFFE;
- седьмой по порядку бит полученного адреса меняется на противоположный (1 – на 0, 0 – на единицу)

Виды трафика в IP
- Unicast – одноадресная передача между двумя конечными узлами;
- Multicast – используется, когда нужно передать какую-то информацию не всем узлам а какой-то определенной группе, при этом узлы группы могут находиться в разных канальных средах;
- Anycast – передача единственному узлу из группы когда есть варианты прохождения запроса; задача выбрать ближайший;
- Broadcast – многоадресная передача группе адресатов; ограничена канальной средой

Типы адресов IPv6
- Global Unicast – аналог «белых» IP адресов для работы в интернете; Пример: 2000::/3
- Unique Local Unicast – локальные адреса, которые не должны попадать в интернет (при этом должны быть уникальны в пределах всего интернета); Пример: fc00::/7
- Link Local Unicast – адреса, доступные в пределах одной канальной среды; Пример: fe80::/10
- Multicast - Пример: ff00::/8
- Специальные адреса - Пример: ::1/128,::/128,...

**Структура глобального IPv6 адреса**

![global1](https://github.com/joos-network/osi7-ipv6-troubleshooting/blob/main/global62.png)
![global2](https://github.com/joos-network/osi7-ipv6-troubleshooting/blob/main/global61.png)

**Структура локального IPv6 адреса**
![local1](https://github.com/joos-network/osi7-ipv6-troubleshooting/blob/main/local6.png)

Векторы атак
- сканирование подсети может затянуться на годы, но вместо сканирования атака может быть произведена на Neighbor Discovery;
- порты на IPv6 должны защищаться так же как в IPv4, либо же стоит отключить их;
- NAT не делает IPv4 безопаснее, а его отсутствие не делает IPv6 более небезопасным;
- IPv6 также подвержен DOS атакам, но за счет отсутствия широковещания проявляет себя лучше при DDOS типа smurf.
