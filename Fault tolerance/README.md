# Disaster recovery
First Hop Redundancy Protocol - Протокол резервирования первого перехода

**FHRP** — семейство сетевых протоколов, которые позволяют объединить группу физических маршрутизаторов в один логический с целью повышения отказоустойчивости локальной сети

Virtual Router Redundancy Protocol - Протокол резервирования виртуального маршрутизатора

**VRRP** — сетевой протокол, предназначенный для увеличения доступности маршрутизаторов, выполняющих роль шлюза по умолчанию. Реализует высокую доступность, создавая виртуальные маршрутизаторы. Если основной маршрутизатор выходит из строя VRRP позволяет переключиться на резервный маршрутизатор.

Виртуальный маршрутизатор назначается шлюзом по умолчанию для участвующих хостов вместо физического маршрутизатора.

**HSRP** — проприетарный протокол от компании Cisco Systems, прародитель протокола VRRP

**Плавающие IP** — дополнительный статический IP-адрес, с помощью которого можно получить доступ к серверу, к которому он в настоящее время прикреплён. Позволяют Быстро переназначить адрес на другой ресурс для увеличения доступности сервиса.

**Keepalived** — сервис для увеличения отказоустойчивости и балансировки нагрузки. Отказоустойчивость достигается при помощи протокола VRRP.

```
vrrp_instance VI_1
  state MASTE
  interface ens3
  virtual_router_id 1
  priority 25
  advert_int

  virtual_ipaddress {
    192.168.111.15/2
  }
}
```

**Что такое disaster recovery** - Согласно отчёту американской компании Datto, минута простоя обходится крупной организации в среднем в $11,7 тыс
Чем крупнее бизнес, тем больше эта сумма. Минута простоя сайта Walmart обойдётся ритейлеру в $40 тыс., а сайта Amazon — в $220 тыс. В 2018 году в результате IT-сбоя британский банк TSB понёс расходы в размере £366 млн и ухудшил отношения с материнской компанией, группой Sabadell

У многих крупных компаний есть план реагирования на ИТ-инциденты Disaster recovery — инструмент восстановления IT-инфраструктуры после стихийного бедствия или сбоя. Например после кибератаки   или отказа оборудования
Реализация disaster recovery основана на управлении рисками и состоит из четырёх этапов:
- Анализ
- Оценка
- Нужен ли план?
- Планирование

Крупному и малому бизнесу необходим план аварийного восстановления, чтобы минимизировать финансовые потери и снизить уровень недоступности системы или её части
**Disaster recovery plan** — документ с детальным описанием всех действий по устранению последствий аварии и восстановлению данных. В нём указаны роли и обязанности ответственных сотрудников, последовательность предпринимаемых ими действий

**Как составляется Disaster Recovery Plan?**
Disaster recovery plan начинается с подсчёта рисков — финансового и репутационного ущерба. При этом затраты на реализацию плана не должны превышать возможных потерь из-за простоя системы
При этом затраты на реализацию плана не должны превышать возможных потерь из-за простоя системы
Разберем каждый ущерб отдельно:
- Финансовый ущерб подсчитывают заранее в денежном эквиваленте: рассчитывают стоимость простоя (час, сутки) по каждому бизнес-процессу. Организация недополучает 100 000 рублей выручки за каждый час упавших серверов
- Репутационный ущерб может оказаться губительнее в перспективе, чем финансовый. Его сложно посчитать в рублях. Для поставщиков IT-услуг простой серверов может означать огромный отток текущих клиентов и недополучение новых заявок

**Типы аварийного восстановления**
Типы аварийного восстановления:
- Резервное копирование
- Горячая резервная площадка
- Холодная резервная площадка
- Аварийное восстановление центра обработки данных
- Аварийное восстановление как услуга

**Резервное копирование** самый простой тип аварийного восстановления, который подразумевает хранение данных в другом расположении или на удалённом накопителе. Резервное копирование обеспечивает минимальную защиту непрерывности бизнеса, потому что нельзя сделать резервную копию IT-инфраструктуры, восстановление данных из резервных копий занимает достаточно много времени

**Горячая резервная площадка** постоянная поддержка наличия актуальных копий данных. Этот метод более трудоемкий и дорогой, чем предыдущий, но значительно сокращает время простоев

**Холодная резервная площадка** этот тип аварийного восстановления подразумевает, что организация устанавливает базовую инфраструктуру на другом, редко используемом объекте, где сотрудники смогут работать после стихийного бедствия. Это способствует поддержанию непрерывности бизнеса, поскольку работа продолжается.  
Такой подход не обеспечивает защиту или восстановление важных данных, поэтому его нужно совмещать с другими типами аварийного восстановления

**Аварийное восстановление ЦОД** (центра обработки данных) постоянная поддержка наличия актуальных копий данных. Физические элементы ЦОД могут обеспечить защиту данных  и способствовать ускоренному аварийному восстановлению при некоторых типах аварий

**Аварийное восстановление как услуга** (disaster recovery as a service) облачный сервис быстрого аварийного восстановления работы виртуальных серверов в резервном центре обработки данных. В случае аварии или кибератаки поставщик услуги DRaaS перемещает вычислительные процессы организации в собственную облачную инфраструктуру. Это позволяет компании продолжать работу из расположения поставщика, даже если её серверы отключены

**Плюсы и минусы типов восстановления**
**Резервное копирование** - Использование: хранение данных в другом расположении или на удалённом накопителе
- Плюсы - Простой тип аварийного восстановления
- Минусы - Нельзя сделать резервную копию IT-инфраструктур, Восстановление данных из резервных копий занимает много времени

**Горячая резервная площадка** - Использование: резервные элементы находятся во включённом состоянии, активно работают и разделяют нагрузку между собой
- Плюсы - Мгновенно готова к работ, Высокая доступность, Обычно используется в качестве кратковременного решения, но иногда её используют длительно
- Минусы - Дорогой и трудоёмкий способ, Возникают ограничения в выборе аппаратного и программного обеспечения

**Холодная резервная площадка** - Использование: резервные узлы выключены и даже могут находиться на складе
- Плюсы - Менее дорогое решение, Доступна на более длительное время за меньшие деньги, Удобно применять, если используется специализированное или дорогостоящее программное обеспечение и оборудование
- Минусы - Доступна только через некоторое время нет возможности быстро начать работу, Обычно её нельзя периодически тестировать, Не обеспечивает защиту или восстановление важных данных, поэтому её необходимо совмещать с другими типами аварийного восстановления

**Аварийное восстановление ЦОД** - Использование: надёжность и безопасность ЦОД увеличивается с каждым уровнем по классификации Tier
- **Tier I** - базовая инфраструктура начального уровня. ЦОД должен иметь: выделенное пространство под IT-оборудования, ИБП, охлаждающие системы, генератор для минимизации простоев при проблемах с питанием
- **Tier II** - Предусмотрены инструменты резервного копирования для особенно важных компонентов при вынужденной остановке вся важная информация будет сохранена
    - Плюсы - При вынужденной остановке вся важная информация будет сохранен, Активное оборудование резервируется по схеме N+1, присутствует один энерговвод
    - Минусы - Полное отключение систем происходит лишь в случае аварийных ситуаций или проведения плановых работ, Допустимое время простоя 22 часа в год, Уровень отказоустойчивости 99,749%
- **Tier III** - Большинство коммерческих и муниципальных учреждений пользуются ЦОД третьего уровня надёжности. Он рассчитан на высокую зависимость инфраструктуры от его работоспособности
    - Плюсы - Возможность ремонта и модернизации без отключения оборудования и прекращения работ, Имеет два энерговвода, активное оборудование резервируется по схеме N + 1, потоки по 2. Отказоустойчивость составляет 99,982, Допустимое время простоя не превышает 1,6 часа в год
- **Tier IV** - предполагает безоговорочную работоспособность вне зависимости от форс мажоров
  - Плюсы - Максимальный показатель доступности 99,99, Допустимое время простоя 26 минут в год
  - Минусы - Четвёртый уровень надёжности требует внушительных затрат: так как дублируются резервные инженерные системы (основные и дополнительные) 2(N + 1), основные и резервные компоненты разнесены по разным помещениям

**Аварийное восстановление как услуга (DRaaS)** - Использование: поставщик услуги DRaaS перемещает вычислительные процессы организации в собственную облачную инфраструктуру
  - Плюсы - Не нужно обслуживать резервную систему и нанимать персона, Облачные решения интегрируются с большинством популярных платформ и могут работать с разным оборудованием и приложениям, Облачные технологии всегда дешевле собственного резервного ЦОД
  - Минусы - Недоверие к поставщику облачных услуг, Зависимость от его услуг

**Критерии оценки эффективности аварийного восстановления**

**Важные параметры аварийного восстановления:**
- RPO (recovery point objective) максимальный период, за который могут быть потеряны данные в результате инцидента
- RTO (recovery time objective) промежуток времени, в течение которого система может оставаться недоступной в случае аварии

Время восстановления файлов из резервного хранилища не должно превышать показатель RPO. Если RPO равен 90 минутам, будут потеряны данные, наработанные не более чем за последние полтора часа. Значит Snapshot (снимок) должен проводиться не реже чем раз в 90 минут.
Резервировать можно не только файлы на дисках, но и настройки приложений, серверных ОС, а также состояние процессов в оперативной памяти.

Значения RTO и RPO каждая организация устанавливает индивидуально исходя из специфики и задач бизнеса:
- Если это клиентский портал банка, время простоя не должно превышать несколько минут
- Персональный сайт может быть недоступен сутки и более

**Уровни настройки RPO для бизнес подразделений**
- До 1 часа - Критически важные операции, в которых нельзя потерять данные более, чем за час. Бизнес транзакции и транзакции с данными обычно имеют больший объём и более динамичны, что делает их воссоздание часто невозможным из за большого количества задействованных переменных. Примеры: банковские транзакции, система CRM и записи пациентов
- От 1 до 4 часов - Бизнес подразделения, которые могут допустить потерю данных на срок до четырёх часов, по своей природе являются полукритическими. Примеры: журналы чатов клиентов и файловые серверы
- От 4 до 12 часов - Бизнес подразделения, попадающие в эту категорию, не могут допустить потери информации более чем за 12 часов Пример: данные о маркетинге и продажах
- От 13 до 24 часов - Бизнес подразделения, входящие в эту категорию, обрабатывают полуважные данные, и им требуется RPO за последние 24 часа. Примеры: отделы кадров и закупок, которые обновляют данные реже, чем исходящие секторы бизнеса

# Кластеризация и балансировка нагрузки

**Nginx** (engine x) — HTTP-сервер и обратный прокси-сервер, почтовый прокси-сервер, а также TCP/UDP-прокси-сервер общего назначения

Config
```
http { # контекст (блочная директива)
  server {
    listen 8000; # простая директива
  location / {
    return 200 'Hello world!';
  }
  }
}
```

- Установим Nginx, проверим конфиг, запустим демон.
- Поднимем два простых сервера на Python, которые будут возвращать разный файл в зависимости от того, на каком порту запущен сервер (simple http server python)
- Узнаем про nginx.conf и про конфиг default.conf
- Покажем, как создать upstream
- Посмотрим результаты через curl
- Затем поменяем вес первого на 5 и проверим: на первый сервер придёт 5 запросов, потом один на второй
- Через секцию stream попробуем настроить TCP-балансировку

**HAProxy** — высокопроизводительный балансировщик нагрузки с открытым исходным кодом и обратный прокси-  сервер для балансировки TCP- и HTTP-трафика

Config
```
listen stats # веб-страница со статистикой 
  bind :888 
  mode http 
  stats enable 
  stats uri /stats 
  stats refresh 5s 
  stats realm Haproxy\ Statistics

frontend example # секция фронтенд 
  mode http 
  bind :8088 
  default_backend web_servers

backend web_servers # секция бэкенд 
  mode http 
  balance roundrobin 
  option httpchk 
  http-check send meth GET uri /index.html 
  server s1 127.0.0.1:8888 check 
  server s2 127.0.0.1:9999 check
```
- Поставим HAProxy
- Посмотрим конфиг
- Посмотрим балансировку по определённому хосту, чтобы при запросе этого хоста было перенаправление на определённый бэкенд
- Различные варианты чеков — HTTP- (с запросом страницы) и TCP-чек
- Увидим в логах сервера при HTTP-чеках, что запросы идут каждую секунду, проверяя жив ли сервер
- Проверим конфиг через
```
haproxy -f /path/to/haproxy.cfg –c
```
- Проверим TCP- и HTTP-балансировку, в случае с TCP-балансировкой указывать хост в заголовках curl необязательно
- Рассмотрим цепочку nginx -> haproxy
- Такая связка полезна, так как HAProxy может проверять здоровье серверов, а Nginx нет

**Кластер** — группа компьютеров, объединённых высокоскоростными каналами связи и представляющая с точки зрения пользователя единый аппаратный ресурс.

Кластерные технологии используют повсюду. Например, на предприятиях, где важна высокая доступность (банки), или в научных исследования, где важны большие мощности и одного сервера будет мало.

**Кластерные вычислительные системы**
- Формируют единый вычислительный ресурс
- Создают иллюзию наличия единственной вычислительной машины

**Перед кластерами стоят две задачи:**
- Достичь большой вычислительной мощности
- Обеспечить повышенную надёжность системы

Кластерная система обеспечивает бесперебойную работу при отказе одного или нескольких узлов.

**Коммутации в кластерах достигают двумя различными способами:**
- Передача сообщений TCP/UDP
- Разделяемая, совместно используемая память

**Типы современных кластерных систем**
- Отказоустойчивые кластеры: HA-кластеры, КВД — кластеры высокой доступности - High-availability clusters
- Кластеры с балансировкой нагрузки - Load balancing clusters
- Вычислительные кластеры - High performance computing clusters
- Системы распределённых вычислений - Distributed computing

**Балансировщик нагрузки** — сервис, распределяющий нагрузку между пулом приложений, которые находятся за ним, стараясь максимизировать скорость и утилизировать ресурсы приложений. Балансировщик нагрузки гарантирует, что приложения   не будут перегружены.

**Решения для балансировки нагрузки бывают двух видов:**
- Hardware-решение — комплекс технических устройств компьютера (аппаратное обеспечение)
- Software-решение — всё программное обеспечение компьютера: программы, операционная система, драйверы и др.

**Балансировка**

**Уровни балансировки** - Чтобы понять балансировку, используют сетевую модель OSI, согласно которой компьютерная сеть состоит из 7 уровней. Каждый уровень выполняет свою роль, и данные передаются по сети с помощью стандартных протоколов связи. Процедура балансировки осуществляется при помощи комплекса алгоритмов и методов, соответствующих следующим уровням модели OSI: сетевой (L3), транспортный (L4), прикладной (L7)

**Сетевая балансировка (L3)** - Задача сделать так, чтобы за один конкретный IP-адрес сервера отвечали разные физические машины.

**Способы балансировки на сетевом уровне:**
- DNS балансировка - Основывается на алгоритмах, как правило, Round Robin. Принцип работы: на одно DNS имя выделяется несколько IP-адресов. Алгоритм позволяет перенаправлять трафик в зависимости от нагрузки серверов.
- Построение NLB-кластера - Несколько физических серверов объединяют в кластер, состоящий из входных и вычислительных узлов. Network Load Balancing возможность балансировать трафик через два или более каналов глобальной сети, не используя сложные протоколы маршрутизации, такие как BGP (протокол динамической маршрутизации).
- Балансировка по IP с использованием дополнительного маршрутизатора. В сети размещают несколько точек входа к сервису, и трафик распараллеливается между маршрутами.
- Балансировка по территориальному признаку - В различных регионах или в странах создают однотипные сервисы с одинаковыми DNS или IP-адресами для более быстрого доступа к ним.

К сетевому уровню относятся решения, которые не терминируют на себе пользовательские сессии. Они просто перенаправляют трафик и не работают в проксирующем режиме. На сетевом уровне балансировщик решает, на какой сервер передавать пакеты. Сессию с клиентом осуществляет сервер.

**Транспортная балансировка (L4)** - Задача: управлять нагрузкой балансировки TCP/UDP-пакетов

**Механизм балансировки на транспортном уровне** - Клиент обращается к балансировщику, тот перенаправляет запрос одному из серверов, который   и будет его обрабатывать. Общение с клиентом замыкается на балансировщике, который работает как прокси. Он взаимодействует с серверами от своего имени, передавая информацию о клиенте в дополнительных данных и заголовках.

Решение популярный программный балансировщик - **HAProxy**

**Прикладная балансировка** - Задача: балансировка протоколов седьмого уровня. При балансировке на прикладном уровне балансировщик работает в режиме «умного прокси».   Он анализирует клиентские запросы и перенаправляет их на разные серверы в зависимости   от характера запрашиваемого контента.

Прикладная балансировка лучше подходит для приложений, которые используют любой протокол мультиплексирования: отправку конкурентных запросов приложений через одно L4 соединение, поддерживающее постоянные подключения keep-alive (сохранение подключения в отсутствие активных запросов).

Все современные протоколы мультиплексирующие и поддерживающие постоянные подключения. Этого требуют соображения эффективности: в целом создавать подключение дорого, особенно если оно шифруется с помощью TLS, так что рассогласование нагрузки в L4 балансировщике со временем усиливается. Эту проблему решают с помощью L7 балансировщика.

**Алгоритмы и методы балансировки**

Желательно, чтобы алгоритм балансировки обладал следующими свойствами:
- Предсказуемость - нужно понимать, в каких ситуациях и при каких нагрузках алгоритм будет эффективным для решения задач
- Равномерная загрузка ресурсов системы
- Масштабируемость - алгоритм должен сохранять работоспособность при увеличении нагрузки

Выделяют следующие алгоритмы и методы балансировки:
- Round robin
- Weighted round robin
- Least connections
- Hash

**Round robin** - Сервер распределяет запросы по пулу. Если в пуле все серверы одинаковой мощности, этот алгоритм подойдёт идеально.

**Weighted round robin** - Похож на Round robin, но имеет дополнительное свойство. С его помощью можно указать балансировщику, сколько трафика отправлять на тот или иной сервер. Так серверы помощнее будут иметь больший вес и обрабатывать больше запросов, чем другие.

**Least connections** - В основе алгоритма лежит очередь с приоритетом, которая отсортирована по количеству активных пользователей, где первый сервер имеет наименьшее количество соединений. Такой способ подходит для систем, где много активных соединений, например, стриминг сервисов или онлайн чатов.

**Hash** - Такой способ использует механизм хеширования. Он позволяет распределить запросы на основе хеша, для которого обычно используется IP-адрес или URL. В таком случае запросы от одного и того же IP будут отправлены на один и тот же сервер. То же самое касается URL. Алгоритм обычно используют, когда сервер хранит локальные данные, которые нужны для ответа.


# Резервное копирование

**Rsync** — программа, которая выполняет синхронизацию файлов и каталогов

**Преимущества rsync**
- Позволяет сохранять символические ссылки, жёсткие ссылки, владельцев и права файла, метаданные и время создания
- Не требует повышенных привилегий для запуска
- Сокращает объём передаваемой по сети информации, так как может передавать только изменённые файлы и даже части файлов

**Основные опции**

-a - Архивный режим, этот параметр определяет сразу комбинацию полезных опций -rlptgoD. Эти параметры позволяют максимально точно рекурсивно синхронизировать каталоги, передавать специальные и блочные устройства, сохранять символические ссылки, время модификации и права доступа

--delete - При использовании этой опции rsync удаляет посторонние файлы из места назначения, это удобно для полной зеркальной копии

--include / --exclude - Опции позволяют включать или исключать определённые файлы и каталоги из синхронизации

Алгоритм работы rsync
- Сравнивает время модификации и размер файла
- Разделяет файлы на фрагменты
- Если они одинаковые, синхронизация не нужна
- Это поведение можно переопределить, чтобы rsync считал контрольную сумму для каждого файла, даже если время и размер у них одинаковы, но это потребует больше времени
- Подсчитывает контрольные суммы с использованием хеш-функции
- Отправляет только изменившиеся части файла

Почему сейчас используют именно режим SSH, а не серверный вариант rsync. В некоторых руководствах предлагают настраивать rsync в серверном режиме (как постоянно запущенный сервис), но у работы по протоколу SSH есть преимущества:
- Надёжная авторизация на основе ключей
- Шифрование передаваемых данных
- Сжатие
- Нет необходимости открывать дополнительные порты на файерволе

**Что такое резервное копирование**

«Запасная» копия данных может понадобиться во многих случаях:
- есть опасность заражения компьютера вирусом — если это произойдёт, данные будут восстановлены благодаря резервной копии
- на компьютере хранится много важной информации — при его поломке резервная копия поможет защитить данные от безвозвратной потери и т. д.

**Резервное копирование** — один из способов сохранения информации на случай вредоносных атак, сбоев в системе, отказа жёсткого диска и других проблем.  По сути, это создание дополнительной копии данных на носителе информации. Резервное копирование необходимо для формирования архива данных, защищённого от изменений и повреждений, а также для восстановления в случае повреждения или сбоев в первоисточнике. Резервирование повышает надёжность, добавляя избыточные данные или устройства для быстрого восстановления работоспособности системы.

**Виды резервного копирования**
- Полное резервное копирование
- Дифференциальное резервное копирование
- Инкрементное резервное копирование
- Клонирование
- Резервное копирование в виде образа
- Резервное копирование в режиме реального времени
- Холодное и горячее резервирование

**Полное резервное копирование** - Принцип работы: делает полное копирование всех исходных данных. Например, исходные данные в размере 100 ГБ и 7 полных копий в сумме составят 700 ГБ в архиве.

**Особенности:**
- самый надёжный вид резервного копирования с точки зрения восстановления данных
- самый долгий с точки зрения протекания процесса
- более удобное управление хранилищем, поскольку весь набор данных содержится в одном файле копии
- регулярное выполнение полного копирования требует огромных запасов хранилища   в резервном репозитории
- оказывает существенную нагрузку на сеть

Большинство организаций делает полный бэкап лишь периодически, совмещая его с другими техниками. При таком подходе полноценное копирование обычно становится стартовой точкой, за которой следует применение дополнительных методов.

**Дифференциальное резервное копирование**

Принцип работы:
- делается полное резервное копирование
- далее при каждом запуске процесса резервируются только изменённые данные, но точка   отсчёта — состояние времени полного бэкапа (самый первый выполненный бэкап)

Например, размер исходных данных составляет 100 ГБ, изменения за один день — 10 ГБ. Относительно копии предыдущего дня уникальные данные занимают 5 ГБ. В итоге 7 дифференциальных копий суммарно составят в архиве 135 ГБ — одна полная копия и изменённые данные с момента предыдущего бэкапа.

**Особенности:**
- этот подход, по сравнению с инкрементным резервным копированием, позволяет быстрее восстанавливать данные, поскольку требует только двух компонентов — начального полного бэкапа и последнего дифференциального
- в плане скорости резервного копирования/восстановления этот метод находится где то между полным и инкрементным методами: процесс быстрее полного копирования, но медленнее инкрементного: восстановление происходит медленнее, чем при полном бэкапе, но быстрее,   чем при инкрементном

Необходимое пространство хранилища, по крайней мере, на определённый период, будет меньше, чем для полного бэкапа, но больше, чем для инкрементного. C течением времени инкременты изменённых данных увеличиваются и в итоге часто начинают требовать даже больше места и времени, чем стандартные полные копии.

**Инкрементное резервное копирование** - Принцип работы: инкрементное копирование работает как дифференциальное копирование, но в отличие от последнего при использовании инкрементного метода происходит бэкап данных, которые изменились с момента последнего слепка. Таким образом, отправная точка каждого нового бэкапа — это бэкап n 1 (предыдущий бэкап). Например, размер исходных данных составляет 100 ГБ. Изменения за один день занимают 10 ГБ, создаётся 7 инкрементальных копий, что в сумме даёт 170 ГБ в архиве — одна полная копия и изменённые данные.

**Особенности:**
- задачи резервного копирования выполняются быстро, поскольку в бэкап отправляются только изменения
- медленный процесс полного восстановления: в первую очередь приходится восстанавливать изначальный полный бэкап, далее — всю следующую за ним цепочку инкрементов; если один из инкрементов будет отсутствовать или окажется повреждён, полноценно восстановить данные не получится
- требуется меньше пространства хранилища по сравнению с полным копированием
- частота выполнения может быть любой, каждый инкремент выступает как отдельная точка восстановления

**Клонирование** - Принцип работы: при клонировании делается резервное копирование не системы или компонента,   а целого раздела или всего диска. Если произойдёт сбой, можно восстановить весь раздел с данными. Например, перед обновлением виртуальной машины можно провести её клонирование (создать дубликат), выполнить процедуру обновления, проверить работоспособность и заменить исходный вариант. При возникновении проблем останется рабочий экземпляр виртуальной машины.

**RAID** — один из вариантов клонирования. RAID (redundant array of independent disks — избыточный массив независимых дисков) — технология виртуализации данных для объединения нескольких физических дисковых устройств   в логический модуль для повышения отказоустойчивости и производительности.

RAID — это не совсем бэкап, поскольку защищает только от аппаратного сбоя. Указанный метод нужен для того, чтобы система не останавливалась из за каждого отказа жёсткого диска. RAID — это про доступность, а не про сохранность данных.

RAID не поможет в следующих случаях:
- повреждение файла
- человеческая ошибка — удаление файлов по ошибке
- катастрофическое повреждение — кто то сбрасывает воду на сервер
- вирусы и другие вредоносные программы
- ошибки программного обеспечения, уничтожающие данные
- аппаратные проблемы, которые уничтожают данные или вызывают повреждение оборудования: неисправности контроллера, ошибки встроенного ПО, скачки напряжения и т. д.

**Резервное копирование в виде образа** - Принцип работы: резервное копирование в виде образа, как и клонирование, производится из слепка системы. Отличие в том, что образ системы можно, например, поместить в контейнер или виртуализировать. Так мы получаем образ с возможностью развёртки без привязки к чему либо. Например, когда мы создаём снапшот виртуального сервера — моментальный снимок полной копии файловой системы, — нам доступно быстрое восстановление сервера на момент создания этого снапшота, причём его можно выполнить на новый виртуальный сервер, даже если он находится на другом оборудовании (необходимо выделить на новом сервере столько же процессоров, памяти и диска). Полная резервная копия образа системы очень эффективна в сценариях аварийного восстановления, когда требуется восстановить все данные с сервера или виртуальной машины с нуля.

**Резервное копирование в режиме реального времени** - Принцип работы: резервное копирование в режиме реального времени позволяет создавать копии файлов, каталогов и томов, не прерывая работу, без перезагрузки компьютера.

Особенности резервного копирования в режиме реального времени:
- происходит на логическом или аппаратном уровнях
- процесс идёт при изменении любого файла, сохраняется копия его состояния до и после
- процесс происходит в реальном времени

**Резервное копирование в режиме реального времени** - Принцип работы: холодное и горячее резервирование — это разновидности резервирования. При работающей системе выполняется горячее резервирование, при перезагрузке компьютера — холодное.

Горячий бэкап даёт существенные преимущества в следующих случаях:
- горячее резервное копирование информации, находящейся в постоянном использовании: горячее копирование баз данных, рабочих файлов совместного проекта и т. д.
- копирование пользовательских данных, которые могут быть открыты в момент выполнения задачи резервного копирования фотографий, картинок, документов, видео и т. д.
- сохранение данных из постоянно открытых приложений, например резервное копирование Outlook

Холодные резервные копии желательно создавать в следующих ситуациях:
- получение цельного массива данных без учёта непрерывных текущих изменений и транзакций: например, при резервном копировании 1С
- снижение нагрузки на сеть или хранилище — иногда требуется при создании бэкапа сайтов по сети

Холодное резервное копирование проходит быстрее, но в это время системой пользоваться невозможно.

**Компоненты и частота резервного копирования**

**Обязательные элементы для резервного копирования**

Резервированию подлежат важные для системы компоненты:
- /etc/, /usr/, /home/
- базы данных
- веб-сервисы
- вся критическая информация
- другие элементы при необходимости

Частота резервного копирования данных на сервере зависит от ряда факторов:
- Как часто изменяются данные в информационной системе
- Какой объём данных подлежит резервному копированию
- Общая нагрузка аппаратной части информационной системы необходимо избегать перегрузки из-за работы системы резервного копирования
- Какого типа данные копируются: базы данных, изображения, текстовые файлы и т. д

**Хранение резервных копий**

- Локально, на самом сервере. Преимущества: простая настройка, быстрый доступ к копиям и высокая скорость копирования. Риски: резервные копии могут быть утеряны, если оборудование выйдет из строя или случится несанкционированный доступ 
- На отдельном физическом носителе это может быть съёмный носитель (портативный жёсткий диск, USB-накопитель и т. п.), который хранится отдельно от компьютера. Преимущества: при утере информации с сервера данные не пострадают и останется возможность их восстановления. Риски: сложная настройка, финансовые затраты на систему хранения и невысокая скорость работы
- Сервер или облачное хранилище. Ключевые преимущества облачного хранилища: доступность облачное хранилище доступно в любое время и с любого устройства (при наличии нормального интернета) гибкость возможность использовать такой объём хранилища, который необходим в настоящий момент; как правило, достаточно просто выбрать нужный тариф. Риски: нужно крайне внимательно относиться к доступам и беречь их, чтобы никто (особенно злоумышленники) не смог проникнуть в ваше хранилище.

**Для обеспечения надёжности хранения резервных копий должно соблюдаться правило 3–2–1**

Везде есть свои недостатки, поэтому самый надёжный способ хранение важных данных в трёх независимых местах:
- Основной носитель, где хранится рабочая копия
- Съёмный физический носитель
- Сервер или облачное хранилище


**Отказоустойчивость в облаке**

У любого сервиса есть **SLA**. SLA — это набор метрик и их допустимых значений между пользователем сервиса и провайдером сервиса. Одна из метрик* SLA для любого сервиса — его доступность

**Отказоустойчивость** — способ увеличения доступности сервиса

**Когда нужна отказоустойчивость**

Когда недоступность сервиса ведёт к финансовым потерям:
- в связи с упущенной выручкой и прибылью
- потерей пользователей/клиентов
- негативной репутацией (пользователи ждут 100% uptime)
- нарушением требований регуляторов
- нарушением критических бизнес-процессов компании
Но отказоустойчивость — это дополнительные затраты на сервис, поэтому важно применять её тогда, когда это целесообразно

**Когда отказоустойчивость необязательна**

Бывают ситуации, когда отказоустойчивость может быть избыточной:
- среды разработки и тестирования
- задачи, у которых нет SLA по доступности, например батч-задачи
Важно во всех сервисах, где доступность приложения — часть SLA, договориться о метриках доступности, даже если высокая доступность не требуется

**Из чего состоит отказоустойчивость**
- Избыточность (redundancy)
- Мониторинг узлов
- Реакция на сбой (failover)
- Возвращение узла в кластер (failback)
Нужно понимать, из каких компонентов состоит сервис, чтобы сделать эти компоненты отказоустойчивыми

**Почему сервис может быть недоступен**
- Атака
- Проблемы из-за инфраструктуры
- Проблемы из-за настроек сервиса

**Как снизить риски сбоя сервиса**

**Атака**

DoS
- Анализируйте приложение на уязвимости. Примеры сканеров: Burp Suite, Acunetix, Nessus
- Можно заказать pentest от Лаборатории Касперского, Group-IB, BI.ZONE
- Используйте web application firewall: Imperva, F5, NGINX Plus, Wallarm, Cloudflare
DDoS
- Яндекс Облако, Qrator Labs, Cloudflare, Akamai
- Автомасштабирование: Instance Groups, Managed Kubernetes

**Сбой на стороне инфраструктуры**

Сбой сервера
- Балансировка нагрузки с использованием healthchecks
- Anti-affinity-правила — гарантия того, что копии сервиса запускаются
Сбой дата-центра
- Балансировка нагрузки на несколько дата-центров
- Disaster recovery

**Сбой из-за лимитов**

Сеть
- Используйте средства для уменьшения паразитной нагрузки
- Горизонтально масштабируйте нагрузку
Диски
- Читайте документацию
- Увеличивайте размер диска и число дисков
- Горизонтально масштабируйте нагрузку

**Сбой на стороне приложения**

ОС
- Мониторинг ОС (потребление RAM, CPU, свободного места)
- Обновление ОС и ядра
- Масштабирование места на диске

Баги
- Dev/stage-среды
- Юнит-тесты, интеграционные тесты
- Возможность сделать rollback
- Современные методики деплоя
- Учения
- Feature-флаги

**Перегрузка**

Реализовывайте сайзинг — приложение должно уметь обрабатывать нагрузку:
- при падении нескольких узлов
- при падении дата-центра

- Готовьтесь к возможной неравномерной балансировке
- Делайте мониторинг нагрузки3
- Делайте нагрузочное тестирование перед вводом в продакшн4
- Приложение должно уметь горизонтально масштабировать входящую нагрузку: автоматически или вручную

Аккуратно комбинируйте резервирование и автомасштабирование: алгоритмы автоскейлинга могут не успеть масштабировать нагрузку при высоких её всплесках

