# Disaster recovery
First Hop Redundancy Protocol - Протокол резервирования первого перехода

**FHRP** — семейство сетевых протоколов, которые позволяют объединить группу физических маршрутизаторов в один логический с целью повышения отказоустойчивости локальной сети

Virtual Router Redundancy Protocol - Протокол резервирования виртуального маршрутизатора

**VRRP** — сетевой протокол, предназначенный для увеличения доступности маршрутизаторов, выполняющих роль шлюза по умолчанию. Реализует высокую доступность, создавая виртуальные маршрутизаторы. Если основной маршрутизатор выходит из строя VRRP позволяет переключиться на резервный маршрутизатор.

Виртуальный маршрутизатор назначается шлюзом по умолчанию для участвующих хостов вместо физического маршрутизатора.

**HSRP** — проприетарный протокол от компании Cisco Systems, прародитель протокола VRRP

**Плавающие IP** — дополнительный статический IP-адрес, с помощью которого можно получить доступ к серверу, к которому он в настоящее время прикреплён. Позволяют Быстро переназначить адрес на другой ресурс для увеличения доступности сервиса.

**Keepalived** — сервис для увеличения отказоустойчивости и балансировки нагрузки. Отказоустойчивость достигается при помощи протокола VRRP.

```
vrrp_instance VI_1
  state MASTE
  interface ens3
  virtual_router_id 1
  priority 25
  advert_int

  virtual_ipaddress {
    192.168.111.15/2
  }
}
```

**Что такое disaster recovery** - Согласно отчёту американской компании Datto, минута простоя обходится крупной организации в среднем в $11,7 тыс
Чем крупнее бизнес, тем больше эта сумма. Минута простоя сайта Walmart обойдётся ритейлеру в $40 тыс., а сайта Amazon — в $220 тыс. В 2018 году в результате IT-сбоя британский банк TSB понёс расходы в размере £366 млн и ухудшил отношения с материнской компанией, группой Sabadell

У многих крупных компаний есть план реагирования на ИТ-инциденты Disaster recovery — инструмент восстановления IT-инфраструктуры после стихийного бедствия или сбоя. Например после кибератаки   или отказа оборудования
Реализация disaster recovery основана на управлении рисками и состоит из четырёх этапов:
- Анализ
- Оценка
- Нужен ли план?
- Планирование

Крупному и малому бизнесу необходим план аварийного восстановления, чтобы минимизировать финансовые потери и снизить уровень недоступности системы или её части
**Disaster recovery plan** — документ с детальным описанием всех действий по устранению последствий аварии и восстановлению данных. В нём указаны роли и обязанности ответственных сотрудников, последовательность предпринимаемых ими действий

**Как составляется Disaster Recovery Plan?**
Disaster recovery plan начинается с подсчёта рисков — финансового и репутационного ущерба. При этом затраты на реализацию плана не должны превышать возможных потерь из-за простоя системы
При этом затраты на реализацию плана не должны превышать возможных потерь из-за простоя системы
Разберем каждый ущерб отдельно:
- Финансовый ущерб подсчитывают заранее в денежном эквиваленте: рассчитывают стоимость простоя (час, сутки) по каждому бизнес-процессу. Организация недополучает 100 000 рублей выручки за каждый час упавших серверов
- Репутационный ущерб может оказаться губительнее в перспективе, чем финансовый. Его сложно посчитать в рублях. Для поставщиков IT-услуг простой серверов может означать огромный отток текущих клиентов и недополучение новых заявок

**Типы аварийного восстановления**
Типы аварийного восстановления:
- Резервное копирование
- Горячая резервная площадка
- Холодная резервная площадка
- Аварийное восстановление центра обработки данных
- Аварийное восстановление как услуга

**Резервное копирование** самый простой тип аварийного восстановления, который подразумевает хранение данных в другом расположении или на удалённом накопителе. Резервное копирование обеспечивает минимальную защиту непрерывности бизнеса, потому что нельзя сделать резервную копию IT-инфраструктуры, восстановление данных из резервных копий занимает достаточно много времени

**Горячая резервная площадка** постоянная поддержка наличия актуальных копий данных. Этот метод более трудоемкий и дорогой, чем предыдущий, но значительно сокращает время простоев

**Холодная резервная площадка** этот тип аварийного восстановления подразумевает, что организация устанавливает базовую инфраструктуру на другом, редко используемом объекте, где сотрудники смогут работать после стихийного бедствия. Это способствует поддержанию непрерывности бизнеса, поскольку работа продолжается.  
Такой подход не обеспечивает защиту или восстановление важных данных, поэтому его нужно совмещать с другими типами аварийного восстановления

**Аварийное восстановление ЦОД** (центра обработки данных) постоянная поддержка наличия актуальных копий данных. Физические элементы ЦОД могут обеспечить защиту данных  и способствовать ускоренному аварийному восстановлению при некоторых типах аварий

**Аварийное восстановление как услуга** (disaster recovery as a service) облачный сервис быстрого аварийного восстановления работы виртуальных серверов в резервном центре обработки данных. В случае аварии или кибератаки поставщик услуги DRaaS перемещает вычислительные процессы организации в собственную облачную инфраструктуру. Это позволяет компании продолжать работу из расположения поставщика, даже если её серверы отключены

**Плюсы и минусы типов восстановления**
**Резервное копирование** - Использование: хранение данных в другом расположении или на удалённом накопителе
- Плюсы - Простой тип аварийного восстановления
- Минусы - Нельзя сделать резервную копию IT-инфраструктур, Восстановление данных из резервных копий занимает много времени

**Горячая резервная площадка** - Использование: резервные элементы находятся во включённом состоянии, активно работают и разделяют нагрузку между собой
- Плюсы - Мгновенно готова к работ, Высокая доступность, Обычно используется в качестве кратковременного решения, но иногда её используют длительно
- Минусы - Дорогой и трудоёмкий способ, Возникают ограничения в выборе аппаратного и программного обеспечения

**Холодная резервная площадка** - Использование: резервные узлы выключены и даже могут находиться на складе
- Плюсы - Менее дорогое решение, Доступна на более длительное время за меньшие деньги, Удобно применять, если используется специализированное или дорогостоящее программное обеспечение и оборудование
- Минусы - Доступна только через некоторое время нет возможности быстро начать работу, Обычно её нельзя периодически тестировать, Не обеспечивает защиту или восстановление важных данных, поэтому её необходимо совмещать с другими типами аварийного восстановления

**Аварийное восстановление ЦОД** - Использование: надёжность и безопасность ЦОД увеличивается с каждым уровнем по классификации Tier
- **Tier I** - базовая инфраструктура начального уровня. ЦОД должен иметь: выделенное пространство под IT-оборудовани, ИБП, охлаждающие системы, генератор для минимизации простоев при проблемах с питанием
- **Tier II** - Предусмотрены инструменты резервного копирования для особенно важных компонентов при вынужденной остановке вся важная информация будет сохранена
    - Плюсы - При вынужденной остановке вся важная информация будет сохранен, Активное оборудование резервируется по схеме N+1, присутствует один энерговвод
    - Минусы - Полное отключение систем происходит лишь в случае аварийных ситуаций или проведения плановых работ, Допустимое время простоя 22 часа в год, Уровень отказоустойчивости 99,749%
- **Tier III** - Большинство коммерческих и муниципальных учреждений пользуются ЦОД третьего уровня надёжности. Он рассчитан на высокую зависимость инфраструктуры от его работоспособности
    - Плюсы - Возможность ремонта и модернизации без отключения оборудования и прекращения работ, Имеет два энерговвода, активное оборудование резервируется по схеме N + 1, потоки по 2, Отказоустойчивость составляет 99,982, Допустимое время простоя не превышает 1,6 часа в год
- **Tier IV** - предполагает безоговорочную работоспособность вне зависимости от форс мажоров
  - Плюсы - Максимальный показатель доступности 99,99, Допустимое время простоя 26 минут в год
  - Минусы - Четвёртый уровень надёжности требует внушительных затрат: так как дублируются резервные инженерные системы (основные и дополнительные) 2(N + 1), основные и резервные компоненты разнесены по разным помещениям

**Аварийное восстановление как услуга (DRaaS)** - Использование: поставщик услуги DRaaS перемещает вычислительные процессы организации в собственную облачную инфраструктуру
  - Плюсы - Не нужно обслуживать резервную систему и нанимать персона, Облачные решения интегрируются с большинством популярных платформ и могут работать с разным оборудованием и приложениям, Облачные технологии всегда дешевле собственного резервного ЦОД
  - Минусы - Недоверие к поставщику облачных услуг, Зависимость от его услуг

**Критерии оценки эффективности аварийного восстановления**

**Важные параметры аварийного восстановления:**
- RPO (recovery point objective) максимальный период, за который могут быть потеряны данные в результате инцидента
- RTO (recovery time objective) промежуток времени, в течение которого система может оставаться недоступной в случае аварии

Время восстановления файлов из резервного хранилища не должно превышать показатель RPO. Если RPO равен 90 минутам, будут потеряны данные, наработанные не более чем за последние полтора часа. Значит Snapshot (снимок) должен проводиться не реже чем раз в 90 минут.
Резервировать можно не только файлы на дисках, но и настройки приложений, серверных ОС, а также состояние процессов в оперативной памяти.

Значения RTO и RPO каждая организация устанавливает индивидуально исходя из специфики и задач бизнеса:
- Если это клиентский портал банка, время простоя не должно превышать несколько минут
- Персональный сайт может быть недоступен сутки и более

**Уровни настройки RPO для бизнес подразделений*
- До 1 часа - Критически важные операции, в которых нельзя потерять данные более, чем за час. Бизнес транзакции и транзакции с данными обычно имеют больший объём и более динамичны, что делает их воссоздание часто невозможным из за большого количества задействованных переменных. Примеры: банковские транзакции, система CRM и записи пациентов
- От 1 до 4 часов - Бизнес подразделения, которые могут допустить потерю данных на срок до четырёх часов, по своей природе являются полукритическими. Примеры: журналы чатов клиентов и файловые серверы
- От 4 до 12 часов - Бизнес подразделения, попадающие в эту категорию, не могут допустить потери информации более чем за 12 часов Пример: данные о маркетинге и продажах
- От 13 до 24 часов - Бизнес подразделения, входящие в эту категорию, обрабатывают полуважные данные, и им требуется RPO за последние 24 часа. Примеры: отделы кадров и закупок, которые обновляют данные реже, чем исходящие секторы бизнеса

# Кластеризация и балансировка нагрузки

**Nginx** (engine x) — HTTP-сервер и обратный прокси-сервер, почтовый прокси-сервер, а также TCP/UDP-прокси-сервер общего назначения

Config
```
http { # контекст (блочная директива)
  server {
    listen 8000; # простая директива
  location / {
    return 200 'Hello world!';
  }
  }
}
```

- Установим Nginx, проверим конфиг, запустим демон.
- Поднимем два простых сервера на Python, которые будут возвращать разный файл в зависимости от того, на каком порту запущен сервер (simple http server python)
- Узнаем про nginx.conf и про конфиг default.conf
- Покажем, как создать upstream
- Посмотрим результаты через curl
- Затем поменяем вес первого на 5 и проверим: на первый сервер придёт 5 запросов, потом один на второй
- Через секцию stream попробуем настроить TCP-балансировку

**HAProxy** — высокопроизводительный балансировщик нагрузки с открытым исходным кодом и обратный прокси-  сервер для балансировки TCP- и HTTP-трафика

Config
```
listen stats # веб-страница со статистикой 
  bind :888 
  mode http 
  stats enable 
  stats uri /stats 
  stats refresh 5s 
  stats realm Haproxy\ Statistics

frontend example # секция фронтенд 
  mode http 
  bind :8088 
  default_backend web_servers

backend web_servers # секция бэкенд 
  mode http 
  balance roundrobin 
  option httpchk 
  http-check send meth GET uri /index.html 
  server s1 127.0.0.1:8888 check 
  server s2 127.0.0.1:9999 check
```
- Поставим HAProxy
- Посмотрим конфиг
- Посмотрим балансировку по определённому хосту, чтобы при запросе этого хоста было перенаправление на определённый бэкенд
- Различные варианты чеков — HTTP- (с запросом страницы) и TCP-чек
- Увидим в логах сервера при HTTP-чеках, что запросы идут каждую секунду, проверяя жив ли сервер
- Проверим конфиг через
```
haproxy -f /path/to/haproxy.cfg –c
```
- Проверим TCP- и HTTP-балансировку, в случае с TCP-балансировкой указывать хост в заголовках curl необязательно
- Рассмотрим цепочку nginx -> haproxy
- Такая связка полезна, так как HAProxy может проверять здоровье серверов, а Nginx нет
